<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>VEX MUSIC - SoundCloud Edition</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              soundcloud: {
                500: "#ff5500", // SoundCloud Orange
                600: "#d94800",
              },
              jamendo: { // Keeping for compatibility or fallback style refs
                500: "#ff5500",
                600: "#d94800",
              },
            },
            animation: {
              "slide-up": "slideUp 0.3s ease-out forwards",
              "spin-slow": "spin 8s linear infinite",
            },
            keyframes: {
              slideUp: {
                "0%": { transform: "translateY(100%)", opacity: "0" },
                "100%": { transform: "translateY(0)", opacity: "1" },
              },
            },
          },
        },
      };
    </script>

    <style>
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: #000;
      }
      ::-webkit-scrollbar-thumb {
        background: #333;
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
      .range-input {
        -webkit-appearance: none;
        background: transparent;
      }
      .range-input::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: 12px;
        width: 12px;
        border-radius: 50%;
        background: #fff;
        margin-top: -4px;
        box-shadow: 0 0 4px rgba(0, 0, 0, 0.5);
        transition: transform 0.1s;
      }
      .range-input:hover::-webkit-slider-thumb {
        transform: scale(1.2);
      }
      .range-input::-webkit-slider-runnable-track {
        width: 100%;
        height: 4px;
        cursor: pointer;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 2px;
      }
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .pb-safe {
        padding-bottom: env(safe-area-inset-bottom);
      }
    </style>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="importmap">
      {
        "imports": {
          "lucide-react": "https://esm.sh/lucide-react@0.294.0",
          "react": "https://esm.sh/react@18.2.0",
          "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
          "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
          "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
          "firebase/database": "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js"
        }
      }
    </script>
  </head>
  <body class="bg-black text-white overflow-hidden touch-none h-screen w-screen">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel" data-type="module">
      import React, {
        createContext,
        useContext,
        useState,
        useEffect,
        useCallback,
        useRef,
      } from "react";
      import ReactDOM from "react-dom/client";
      import {
        Home, Search, Library, PlusSquare, Heart, Globe, Music2,
        LogIn, LogOut, Play, Pause, SkipBack, SkipForward, Repeat,
        Shuffle, Volume2, Volume1, VolumeX, Maximize2, ChevronDown,
        Share2, MoreHorizontal, ListMusic, X, GripVertical, Moon,
        Clock, Download, TrendingUp, History, Sparkles, Coffee,
        Dumbbell, PartyPopper, CheckCircle, Music, Plus, User,
        Radio, Trash2, Users, Cloud
      } from "lucide-react";
      import { initializeApp } from "firebase/app";
      import {
        getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
        onAuthStateChanged, signOut
      } from "firebase/auth";
      import { getDatabase, ref, push, set, onValue, get, update, remove } from "firebase/database";

      // --- CONFIG & SOUNDCLOUD API ---
      const SC_CLIENT_ID = "IGGuiv3ziHDO8Z9fhllehL1D4UKGc8eH";
      const SC_API_BASE = "https://api.soundcloud.com";

      const firebaseConfig = {
        apiKey: "AIzaSyA6jb5U-x8CSFtHCZMVqHaWzLeV98MoWGE",
        authDomain: "studio-3733366627-e5d3d.firebaseapp.com",
        databaseURL: "https://studio-3733366627-e5d3d-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "studio-3733366627-e5d3d",
        storageBucket: "studio-3733366627-e5d3d.firebasestorage.app",
        messagingSenderId: "195800850019",
        appId: "1:195800850019:web:1730ace5541b7a10126256",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getDatabase(app);

      // --- CACHE & HELPERS ---
      const cache = new Map();
      const CACHE_DURATION = 1000 * 60 * 15; // 15 mins

      const getCached = (key) => {
        const item = cache.get(key);
        if (item && Date.now() - item.timestamp < CACHE_DURATION) return item.data;
        return null;
      };
      const setCache = (key, data) => cache.set(key, { timestamp: Date.now(), data });
      
      const shuffle = (array) => array.sort(() => Math.random() - 0.5);

      // --- SOUNDCLOUD SERVICE ---
      
      const mapSoundCloudTrack = (track) => {
        // Handle artwork resolution
        let image = track.artwork_url || track.user?.avatar_url || "https://images.unsplash.com/photo-1470225620780-dba8ba36b745?w=500&q=80";
        if(track.artwork_url) {
            image = track.artwork_url.replace('-large', '-t500x500');
        }

        // Construct stream URL
        // Note: Using standard V1 stream endpoint pattern. 
        // Some tracks may be restricted, but this is the standard method for public tracks with a Client ID.
        const audio = `${SC_API_BASE}/tracks/${track.id}/stream?client_id=${SC_CLIENT_ID}`;

        return {
          id: `sc_${track.id}`,
          original_id: track.id,
          name: track.title,
          duration: Math.floor(track.duration / 1000), // ms to seconds
          artist_id: String(track.user_id),
          artist_name: track.user?.username || "Unknown Artist",
          album_name: track.genre || "Single",
          album_id: "0",
          album_image: image,
          audio: audio,
          shareurl: track.permalink_url,
          image: image,
          source: "soundcloud",
          tags: track.tag_list ? track.tag_list.split(' ').map(t => t.replace(/"/g, '')) : [track.genre || "Music"],
          likes: track.likes_count,
          playback_count: track.playback_count
        };
      };

      const fetchSoundCloud = async (path, params = {}) => {
        // Construct query
        const url = new URL(`${SC_API_BASE}${path}`);
        url.searchParams.append("client_id", SC_CLIENT_ID);
        url.searchParams.append("linked_partitioning", "1"); // Pagination support
        url.searchParams.append("limit", "20");
        
        Object.entries(params).forEach(([k, v]) => url.searchParams.append(k, v));
        
        const cacheKey = url.toString();
        const cached = getCached(cacheKey);
        if (cached) return cached;

        try {
          const res = await fetch(url.toString());
          if (!res.ok) throw new Error("SC API Error");
          const json = await res.json();
          
          // SC responses with linked_partitioning usually have a 'collection' array
          // Some endpoints return the array directly or a different structure
          let rawTracks = [];
          if (Array.isArray(json)) rawTracks = json;
          else if (json.collection) rawTracks = json.collection;
          
          // Map and filter streamable tracks
          const tracks = rawTracks
            .filter(t => t.streamable && t.kind === 'track')
            .map(mapSoundCloudTrack);
            
          setCache(cacheKey, tracks);
          return tracks;
        } catch (e) {
          console.warn("SoundCloud fetch error:", e);
          return [];
        }
      };

      const searchSoundCloud = (query) => fetchSoundCloud("/tracks", { q: query });
      
      // Use tags to emulate trending/charts since SC doesn't have a simple public "top 50" endpoint without specific playlist IDs
      const getSoundCloudTrending = (genre = "pop") => fetchSoundCloud("/tracks", { tags: genre, order: 'hotness' });

      // --- RECOMMENDATION LOGIC ---

      const analyzeTasteProfile = (history) => {
        if (history.length === 0)
          return { topTags: ["pop", "house"], vibe: "Newcomer" };
        
        const tagCounts = {};
        history.forEach((track) => {
          track.tags?.forEach((tag) => {
            const clean = tag.toLowerCase().trim();
            if(clean.length > 2) tagCounts[clean] = (tagCounts[clean] || 0) + 1;
          });
        });

        const topTags = Object.entries(tagCounts)
          .sort(([, a], [, b]) => b - a)
          .slice(0, 5)
          .map(([t]) => t);

        let vibe = "Eclectic";
        if (topTags.some(t => t.includes("hip") || t.includes("rap"))) vibe = "Hype";
        else if (topTags.some(t => t.includes("chill") || t.includes("lofi"))) vibe = "Chill";
        else if (topTags.some(t => t.includes("house") || t.includes("edm"))) vibe = "Party";
        else if (topTags.some(t => t.includes("rock") || t.includes("metal"))) vibe = "Rocker";

        return { topTags, vibe };
      };

      const getDailyMix = async (profile) => {
        const query = profile.topTags[0] || "pop";
        return await fetchSoundCloud("/tracks", { tags: query, limit: 30 });
      };

      const getExploreConfig = () => [
        { title: "Global Viral", query: "viral" },
        { title: "Fresh Hip-Hop", query: "hiphop" },
        { title: "Electronic Vibes", query: "electronic" },
        { title: "Chill & Lofi", query: "lofi" },
        { title: "Alternative Rock", query: "rock" },
      ];

      // --- CONTEXTS ---
      const AuthContext = createContext(undefined);
      const useAuth = () => useContext(AuthContext);

      const AuthProvider = ({ children }) => {
        const [currentUser, setCurrentUser] = useState(null);
        const [loading, setLoading] = useState(true);
        useEffect(() => onAuthStateChanged(auth, (u) => { setCurrentUser(u); setLoading(false); }), []);
        const logout = () => signOut(auth);
        return <AuthContext.Provider value={{ currentUser, loading, logout }}>{!loading && children}</AuthContext.Provider>;
      };

      const PlayerContext = createContext(undefined);
      const usePlayer = () => useContext(PlayerContext);

      const PlayerProvider = ({ children }) => {
        const [state, setState] = useState({
          currentTrack: null, isPlaying: false, volume: parseFloat(localStorage.getItem("vex_vol") || "1"),
          currentTime: 0, duration: 0, queue: [], history: [], isShuffling: false, repeatMode: "off",
        });
        const [favorites, setFavorites] = useState([]);
        const [sleepTimerTime, setSleepTimerTime] = useState(null);
        const audioRef = useRef(null);
        const sleepTimerRef = useRef(null);

        useEffect(() => {
          try {
            const f = localStorage.getItem("vex_favs");
            if (f) setFavorites(JSON.parse(f));
            const h = localStorage.getItem("vex_hist");
            if (h) setState((p) => ({ ...p, history: JSON.parse(h) }));
          } catch (e) {}
        }, []);

        // Audio setup and event listeners
        useEffect(() => {
          const audio = new Audio();
          audio.crossOrigin = "anonymous"; // Important for SC
          audioRef.current = audio;
          
          const update = () => setState((p) => ({ ...p, currentTime: audio.currentTime }));
          const dur = () => !Number.isNaN(audio.duration) && setState((p) => ({ ...p, duration: audio.duration }));
          const end = () => nextTrack();
          const err = (e) => console.error("Audio Error", e);

          audio.addEventListener("timeupdate", update);
          audio.addEventListener("loadedmetadata", dur);
          audio.addEventListener("ended", end);
          audio.addEventListener("error", err);
          return () => {
            audio.pause();
            audio.removeEventListener("timeupdate", update);
            audio.removeEventListener("loadedmetadata", dur);
            audio.removeEventListener("ended", end);
            audio.removeEventListener("error", err);
          };
        }, []);

        useEffect(() => {
          if (!audioRef.current) return;
          audioRef.current.volume = state.volume;
          audioRef.current.loop = state.repeatMode === "one";
          localStorage.setItem("vex_vol", state.volume.toString());
        }, [state.volume, state.repeatMode]);

        useEffect(() => {
          const audio = audioRef.current;
          if (!audio) return;
          if (state.currentTrack) {
            // Only change src if it's different to prevent reloading on play/pause
            if (audio.src !== state.currentTrack.audio) {
              audio.src = state.currentTrack.audio;
              audio.load();
              // Update history
              setState(prev => {
                  const nh = [state.currentTrack, ...prev.history.filter(t => t.id !== state.currentTrack.id)].slice(0, 20);
                  localStorage.setItem("vex_hist", JSON.stringify(nh));
                  return { ...prev, history: nh };
              });
            }
            if (state.isPlaying) {
                const playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => console.log("Playback prevented:", error));
                }
            } else {
                audio.pause();
            }
          } else {
            audio.pause();
          }
        }, [state.currentTrack, state.isPlaying]);

        // Sleep Timer Logic
        useEffect(() => {
            if (!sleepTimerTime) return;
            const check = setInterval(() => {
                if (Date.now() >= sleepTimerTime) {
                    setState(p => ({ ...p, isPlaying: false }));
                    setSleepTimerTime(null);
                    clearInterval(check);
                }
            }, 1000);
            return () => clearInterval(check);
        }, [sleepTimerTime]);

        const playTrack = (t) => setState((p) => ({ ...p, currentTrack: t, isPlaying: true, queue: [t] }));
        const playPlaylist = (t, i = 0) => setState((p) => ({ ...p, queue: t, currentTrack: t[i], isPlaying: true }));
        const togglePlay = () => setState((p) => p.currentTrack ? { ...p, isPlaying: !p.isPlaying } : p);
        const setVolume = (v) => setState((p) => ({ ...p, volume: v }));
        const seek = (t) => { if (audioRef.current) { audioRef.current.currentTime = t; setState((p) => ({ ...p, currentTime: t })); }};
        const toggleShuffle = () => setState((p) => ({ ...p, isShuffling: !p.isShuffling }));
        const toggleRepeat = () => setState((p) => ({ ...p, repeatMode: p.repeatMode === "off" ? "all" : p.repeatMode === "all" ? "one" : "off" }));
        
        const nextTrack = () => {
             setState(p => {
                if (!p.currentTrack || !p.queue.length) return p;
                const currIdx = p.queue.findIndex(t => t.id === p.currentTrack.id);
                let nextIdx = currIdx + 1;
                if (p.isShuffling) nextIdx = Math.floor(Math.random() * p.queue.length);
                if (nextIdx >= p.queue.length) {
                    if (p.repeatMode === "all") nextIdx = 0;
                    else return { ...p, isPlaying: false };
                }
                return { ...p, currentTrack: p.queue[nextIdx], isPlaying: true };
            });
        };

        const prevTrack = () => {
            if(audioRef.current && audioRef.current.currentTime > 3) {
                audioRef.current.currentTime = 0;
                return;
            }
            setState(p => {
                if (!p.currentTrack || !p.queue.length) return p;
                const currIdx = p.queue.findIndex(t => t.id === p.currentTrack.id);
                let prevIdx = currIdx - 1;
                if (prevIdx < 0) prevIdx = p.queue.length - 1;
                return { ...p, currentTrack: p.queue[prevIdx], isPlaying: true };
            });
        };

        const toggleFavorite = (t) => setFavorites((prev) => {
            const exists = prev.some((x) => x.id === t.id);
            const nf = exists ? prev.filter((x) => x.id !== t.id) : [...prev, t];
            localStorage.setItem("vex_favs", JSON.stringify(nf));
            return nf;
        });

        return (
          <PlayerContext.Provider
            value={{
              ...state, playTrack, playPlaylist, togglePlay, nextTrack, prevTrack, seek, setVolume,
              toggleShuffle, toggleRepeat, favorites, toggleFavorite,
              isFavorite: (id) => favorites.some((t) => t.id === id),
              setSleepTimer: (m) => setSleepTimerTime(m ? Date.now() + m * 60000 : null), sleepTimerTime,
              addToQueue: (t) => setState(p => ({...p, queue: [...p.queue, t]})),
              removeFromQueue: (i) => setState(p => { const q=[...p.queue]; q.splice(i,1); return {...p, queue:q} })
            }}
          >
            {children}
          </PlayerContext.Provider>
        );
      };

      // --- UI COMPONENTS ---
      
      const Sidebar = ({ currentView, onChangeView, onCreatePlaylist }) => {
        const { currentUser, logout } = useAuth();
        return (
          <div className="hidden md:flex w-64 bg-black h-full flex-col flex-shrink-0 text-gray-400 font-medium z-40 border-r border-[#222]">
            <div className="p-6">
              <h1 className="text-white text-2xl font-black tracking-tight flex items-center gap-2">
                <div className="bg-gradient-to-tr from-soundcloud-600 to-soundcloud-500 rounded p-1">
                  <Cloud className="text-white" size={24} fill="currentColor" />
                </div>
                <span>VEX MUSIC</span>
              </h1>
            </div>
            <nav className="flex-1 px-3 space-y-1 overflow-y-auto">
              {[
                { id: "home", icon: <Home size={22} />, l: "Home" },
                { id: "search", icon: <Search size={22} />, l: "Search" },
                { id: "library", icon: <Library size={22} />, l: "Library" },
                { id: "community", icon: <Users size={22} />, l: "Community" },
              ].map((i) => (
                <button key={i.id} onClick={() => onChangeView(i.id)} className={`w-full flex items-center gap-4 px-4 py-3 rounded-lg transition-all duration-200 font-bold ${currentView === i.id ? "bg-[#222] text-white" : "hover:text-white hover:bg-[#111]"}`}>
                  {i.icon} <span>{i.l}</span>
                </button>
              ))}

              <div className="px-4 mb-2 mt-6 text-[10px] font-black uppercase tracking-widest text-gray-600">Discover Genres</div>
              {[
                { id: "pop", l: "Pop Charts" },
                { id: "hiphop", l: "Hip-Hop / Rap" },
                { id: "electronic", l: "Electronic / Dance" },
              ].map((i) => (
                <button key={i.id} onClick={() => onChangeView(i.id)} className={`w-full flex items-center gap-4 px-4 py-3 rounded-lg transition-all duration-200 ${currentView === i.id ? "bg-[#222] text-white" : "hover:text-white hover:bg-[#111]"}`}>
                  <Radio size={22} /> <span>{i.l}</span>
                </button>
              ))}

              <div className="mt-auto pt-6 border-t border-[#222] px-2 space-y-2">
                <button onClick={() => onChangeView("liked")} className={`w-full flex items-center gap-4 px-4 py-3 rounded-lg transition-all group ${currentView === "liked" ? "bg-[#222] text-white" : "hover:text-white"}`}>
                  <div className="bg-gradient-to-br from-indigo-700 to-blue-300 rounded-sm p-1 text-white group-hover:scale-110 transition"><Heart size={18} fill="white" /></div>
                  <span>Liked Songs</span>
                </button>
                <button onClick={onCreatePlaylist} className="w-full flex items-center gap-4 px-4 py-3 rounded-lg hover:text-white transition-all group">
                  <div className="bg-gray-300 rounded-sm p-1 text-black group-hover:scale-110 transition"><PlusSquare size={18} /></div>
                  <span>Create Playlist</span>
                </button>
              </div>
            </nav>
            <div className="px-6 py-6 border-t border-[#222]">
              {currentUser ? (
                <div className="flex flex-col gap-3">
                  <div className="text-xs text-gray-500 font-bold uppercase tracking-wider">Logged in as</div>
                  <div className="text-sm font-bold text-white truncate">{currentUser.email}</div>
                  <button onClick={logout} className="flex items-center gap-2 text-red-500 hover:text-red-400 text-sm font-bold transition mt-2"><LogOut size={16} /> Logout</button>
                </div>
              ) : (
                <button onClick={() => onChangeView("auth")} className="w-full py-3 bg-white text-black font-bold rounded-full hover:scale-105 transition flex items-center justify-center gap-2"><LogIn size={18} /> Login</button>
              )}
            </div>
          </div>
        );
      };

      const TrackList = ({ tracks, onPlay, onMenuClick }) => {
        const { currentTrack, isPlaying, toggleFavorite, isFavorite } = usePlayer();
        const format = (s) => `${Math.floor(s / 60)}:${Math.floor(s % 60).toString().padStart(2, "0")}`;
        
        return (
          <div className="w-full pb-32 md:pb-12">
            <div className="hidden md:grid grid-cols-[24px_4fr_3fr_minmax(60px,1fr)_40px] gap-4 px-4 py-2 border-b border-white/10 text-gray-400 text-xs font-bold uppercase tracking-wider sticky top-[64px] bg-[#121212]/95 backdrop-blur-md z-10 mb-2">
              <div>#</div><div>Title</div><div>Genre/Album</div><div className="flex justify-end"><Clock size={14} /></div><div></div>
            </div>
            <div className="space-y-0.5">
              {tracks.map((t, i) => {
                const active = currentTrack?.id === t.id;
                return (
                  <div key={t.id} onClick={() => onPlay(t, tracks)} className={`group grid grid-cols-[auto_1fr_40px] md:grid-cols-[24px_4fr_3fr_minmax(60px,1fr)_40px] gap-4 px-4 py-2 md:py-2.5 rounded-lg items-center cursor-pointer transition duration-200 ${active ? "bg-white/10" : "hover:bg-white/5"}`}>
                    <div className="hidden md:flex items-center justify-center w-6">
                      {active && isPlaying ? (
                        <div className="flex gap-[2px] items-end h-3">
                          <span className="w-0.5 bg-soundcloud-500 h-2 animate-pulse" />
                          <span className="w-0.5 bg-soundcloud-500 h-3 animate-pulse delay-75" />
                          <span className="w-0.5 bg-soundcloud-500 h-1 animate-pulse delay-150" />
                        </div>
                      ) : (
                        <span className="text-gray-500 group-hover:hidden text-sm font-medium">{i + 1}</span>
                      )}
                      <Play size={14} fill="white" className={`hidden text-white ${active && isPlaying ? "hidden" : "group-hover:block"}`} />
                    </div>
                    <div className="flex items-center gap-4 overflow-hidden">
                      <div className="relative w-10 h-10 md:w-10 md:h-10 flex-shrink-0">
                        <img src={t.album_image} alt="" className={`w-full h-full rounded object-cover shadow-lg ${active ? "opacity-50" : ""}`} />
                        {active && <div className="absolute inset-0 flex items-center justify-center"><div className="flex items-end gap-[2px] h-3"><span className="w-1 bg-soundcloud-500 h-full animate-pulse" /></div></div>}
                      </div>
                      <div className="flex flex-col overflow-hidden justify-center">
                        <span className={`truncate font-bold text-sm mb-0.5 ${active ? "text-soundcloud-500" : "text-white"}`}>{t.name}</span>
                        <span className="text-xs text-gray-400 truncate hover:underline hover:text-white cursor-pointer w-fit">{t.artist_name}</span>
                      </div>
                    </div>
                    <div className="hidden md:block truncate text-xs text-gray-400 font-medium">{t.album_name}</div>
                    <div className="flex items-center justify-end gap-4 text-xs font-medium text-gray-400">
                      <button onClick={(e) => { e.stopPropagation(); toggleFavorite(t); }} className={`hover:scale-110 transition ${isFavorite(t.id) ? "text-soundcloud-500" : "text-gray-500 hover:text-white opacity-0 group-hover:opacity-100"}`}>
                        <Heart size={16} fill={isFavorite(t.id) ? "currentColor" : "none"} />
                      </button>
                      <span className="hidden md:block tabular-nums">{format(t.duration)}</span>
                    </div>
                    <div className="flex justify-end">
                      <button onClick={(e) => { e.stopPropagation(); onMenuClick?.(t); }} className="text-gray-400 hover:text-white p-1"><MoreHorizontal size={18} /></button>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        );
      };

      const Section = ({ title, tracks, onPlay }) => {
        if (!tracks || tracks.length === 0) return null;
        return (
          <div className="mb-10 px-4 md:px-0 animate-slide-up">
            <h2 className="text-2xl font-bold text-white tracking-tight mb-4">{title}</h2>
            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6">
              {tracks.slice(0, 5).map((track) => (
                <div key={track.id} onClick={() => onPlay(track)} className="group bg-[#181818] hover:bg-[#282828] p-4 rounded-lg transition-all duration-300 cursor-pointer hover:-translate-y-2 hover:shadow-xl relative">
                  <div className="relative mb-4 aspect-square shadow-black/50 shadow-lg rounded-md overflow-hidden">
                    <img src={track.album_image} className="w-full h-full object-cover group-hover:scale-105 transition duration-500" />
                    <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-all duration-300 flex items-center justify-center translate-y-4 group-hover:translate-y-0">
                      <div className="bg-soundcloud-500 rounded-full p-3.5 text-white shadow-xl hover:scale-105 transition transform"><Play fill="currentColor" size={24} className="ml-1" /></div>
                    </div>
                  </div>
                  <h3 className="font-bold text-white truncate mb-1 text-sm">{track.name}</h3>
                  <p className="text-xs text-gray-400 truncate font-medium">{track.artist_name}</p>
                </div>
              ))}
            </div>
          </div>
        );
      };

      // --- PLAYER UI ---
      const Player = () => {
        const { currentTrack, isPlaying, togglePlay, nextTrack, prevTrack, volume, setVolume, currentTime, duration, seek, queue, removeFromQueue } = usePlayer();
        const [full, setFull] = useState(false);
        const [qOpen, setQOpen] = useState(false);
        
        if (!currentTrack) return null;
        const progress = duration ? (currentTime / duration) * 100 : 0;
        const fmt = (t) => `${Math.floor(t / 60)}:${Math.floor(t % 60).toString().padStart(2, "0")}`;

        return (
            <>
                <div onClick={() => setFull(true)} className="md:hidden fixed bottom-[60px] left-3 right-3 h-16 bg-[#222]/90 backdrop-blur-md rounded-xl flex items-center px-3 shadow-2xl z-50 border border-white/10">
                    <img src={currentTrack.album_image} className={`h-10 w-10 rounded-md object-cover mr-3 ${isPlaying ? "animate-[spin_10s_linear_infinite]" : ""}`} style={{ animationPlayState: isPlaying ? "running" : "paused" }} />
                    <div className="flex-1 overflow-hidden min-w-0 flex flex-col justify-center mr-2">
                        <span className="text-white font-bold text-sm truncate">{currentTrack.name}</span>
                        <span className="text-gray-400 text-xs truncate">{currentTrack.artist_name}</span>
                    </div>
                    <button onClick={(e) => { e.stopPropagation(); togglePlay(); }} className="text-white p-3">{isPlaying ? <Pause size={24} fill="white" /> : <Play size={24} fill="white" />}</button>
                    <div className="absolute bottom-0 left-3 right-3 h-[2px] bg-white/10 rounded-full overflow-hidden"><div className="h-full bg-soundcloud-500" style={{ width: `${progress}%` }} /></div>
                </div>

                <div className="hidden md:grid h-24 bg-black/90 backdrop-blur-xl border-t border-white/5 px-6 grid-cols-3 items-center fixed bottom-0 left-0 right-0 z-[60] text-white shadow-2xl">
                    <div className="flex items-center gap-4 min-w-0 overflow-hidden">
                        <img src={currentTrack.album_image} className="h-14 w-14 rounded-md shadow-lg" />
                        <div className="flex flex-col min-w-0 overflow-hidden">
                            <span className="font-bold text-sm truncate">{currentTrack.name}</span>
                            <span className="text-xs text-gray-400 font-medium truncate">{currentTrack.artist_name}</span>
                        </div>
                    </div>
                    <div className="flex flex-col items-center max-w-md mx-auto w-full">
                        <div className="flex items-center gap-6 mb-1.5">
                            <button onClick={prevTrack} className="text-gray-300 hover:text-white transition hover:scale-110"><SkipBack size={24} fill="currentColor" /></button>
                            <button onClick={togglePlay} className="w-9 h-9 bg-white rounded-full flex items-center justify-center text-black hover:scale-105 transition shadow-lg">{isPlaying ? <Pause size={20} fill="black" /> : <Play size={20} fill="black" className="ml-0.5" />}</button>
                            <button onClick={nextTrack} className="text-gray-300 hover:text-white transition hover:scale-110"><SkipForward size={24} fill="currentColor" /></button>
                        </div>
                        <div className="flex w-full items-center gap-2 text-xs font-medium text-gray-500 font-mono">
                            <span className="w-8 text-right">{fmt(currentTime)}</span>
                            <div className="relative flex-1 h-1 bg-white/10 rounded-full group cursor-pointer">
                                <div className="absolute h-full bg-white group-hover:bg-soundcloud-500 rounded-full transition-colors" style={{ width: `${progress}%` }} />
                                <input type="range" min="0" max="100" value={progress || 0} onChange={(e) => seek((Number(e.target.value) / 100) * duration)} className="absolute w-full h-full opacity-0 z-10 cursor-pointer" />
                            </div>
                            <span className="w-8">{fmt(duration)}</span>
                        </div>
                    </div>
                    <div className="flex items-center justify-end gap-3">
                         <div className="flex items-center gap-2 w-28 group">
                            <Volume2 size={18} className="text-gray-400" />
                            <div className="relative flex-1 h-1 bg-white/10 rounded-full overflow-hidden">
                                <div className="absolute h-full bg-gray-400 group-hover:bg-white rounded-full" style={{ width: `${volume * 100}%` }} />
                                <input type="range" min="0" max="1" step="0.01" value={volume} onChange={(e) => setVolume(Number(e.target.value))} className="absolute w-full h-full opacity-0 z-10 cursor-pointer" />
                            </div>
                        </div>
                    </div>
                </div>
                
                {full && (
                    <div className="fixed inset-0 z-[100] bg-black flex flex-col md:hidden pb-safe">
                         <div className="flex items-center justify-between p-6">
                            <button onClick={() => setFull(false)}><ChevronDown size={28} /></button>
                            <span className="text-[10px] font-bold uppercase text-gray-400">Now Playing from SoundCloud</span>
                            <button><MoreHorizontal size={24} /></button>
                         </div>
                         <div className="flex-1 px-8 flex flex-col justify-center">
                            <img src={currentTrack.album_image.replace("t500x500", "original")} className="w-full aspect-square rounded-xl shadow-2xl mb-8 object-cover bg-gray-800" />
                            <h2 className="text-2xl font-bold mb-1">{currentTrack.name}</h2>
                            <p className="text-gray-400 text-lg mb-8">{currentTrack.artist_name}</p>
                            <div className="relative h-1.5 bg-white/20 rounded-full mb-3">
                                <div className="absolute h-full bg-white rounded-full" style={{ width: `${progress}%` }} />
                                <input type="range" min="0" max="100" value={progress || 0} onChange={(e) => seek((Number(e.target.value) / 100) * duration)} className="absolute w-full h-full opacity-0 z-10" />
                            </div>
                            <div className="flex justify-between text-xs font-bold text-gray-400 mb-8"><span>{fmt(currentTime)}</span><span>{fmt(duration)}</span></div>
                            <div className="flex items-center justify-between">
                                <button onClick={prevTrack}><SkipBack size={32} /></button>
                                <button onClick={togglePlay} className="w-16 h-16 bg-white rounded-full flex items-center justify-center text-black"><div className="ml-1">{isPlaying ? <Pause size={32} fill="black" /> : <Play size={32} fill="black" />}</div></button>
                                <button onClick={nextTrack}><SkipForward size={32} /></button>
                            </div>
                         </div>
                    </div>
                )}
            </>
        );
      };

      // --- MAIN APP ---
      
      const ContentArea = () => {
        const [view, setView] = useState("home");
        const [trending, setTrending] = useState([]);
        const [daily, setDaily] = useState([]);
        const [loading, setLoading] = useState(false);
        const [greet, setGreet] = useState("Hello");
        const { playPlaylist, history } = usePlayer();
        const { currentUser } = useAuth();
        const loaded = useRef(false);

        useEffect(() => {
            const h = new Date().getHours();
            setGreet(h < 12 ? "Good Morning" : h < 18 ? "Good Afternoon" : "Good Evening");
            if (!loaded.current) {
                loadHome();
                loaded.current = true;
            }
        }, []);

        useEffect(() => {
            if(view === "pop") { setLoading(true); getSoundCloudTrending("pop").then(t => { setTrending(t); setLoading(false); }); }
            if(view === "hiphop") { setLoading(true); getSoundCloudTrending("hiphop").then(t => { setTrending(t); setLoading(false); }); }
            if(view === "electronic") { setLoading(true); getSoundCloudTrending("electronic").then(t => { setTrending(t); setLoading(false); }); }
        }, [view]);

        const loadHome = async () => {
            const p = analyzeTasteProfile(history);
            const [d, t] = await Promise.all([getDailyMix(p), getSoundCloudTrending("pop")]);
            setDaily(d);
            setTrending(t);
        };

        const onSearch = async (q) => {
            setView("search");
            setLoading(true);
            const res = await searchSoundCloud(q);
            setTrending(res);
            setLoading(false);
        };

        return (
            <div className="flex h-screen bg-black text-white font-sans selection:bg-soundcloud-500 selection:text-white">
                <Sidebar currentView={view} onChangeView={setView} onCreatePlaylist={() => {}} />
                <main className="flex-1 bg-[#121212] flex flex-col relative overflow-hidden">
                    <div className="h-20 flex items-center px-6 md:px-8 justify-between sticky top-0 z-30 bg-[#121212]/95 backdrop-blur-xl border-b border-white/5">
                         <div className="flex items-center gap-4 w-full max-w-xl">
                            {view === "search" ? (
                                <div className="relative w-full">
                                    <Search className="absolute left-4 top-3.5 text-gray-500" size={18} />
                                    <input type="text" placeholder="Search SoundCloud..." className="w-full bg-[#222] rounded-full py-3 pl-12 pr-4 outline-none focus:ring-2 ring-soundcloud-500" onKeyDown={(e) => e.key === "Enter" && onSearch(e.target.value)} />
                                </div>
                            ) : <h2 className="text-xl font-black tracking-tight">{greet}</h2>}
                         </div>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto pb-32 scroll-smooth custom-scrollbar px-6 md:px-8 pt-8">
                        {loading && <div className="flex justify-center py-20"><div className="w-10 h-10 border-4 border-soundcloud-500 border-t-transparent rounded-full animate-spin"></div></div>}
                        
                        {!loading && view === "home" && (
                            <>
                                <div className="relative bg-gradient-to-r from-orange-600 to-soundcloud-600 rounded-3xl p-8 md:p-12 mb-12 flex flex-col md:flex-row items-end justify-between shadow-2xl overflow-hidden animate-slide-up">
                                    <div className="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20 mix-blend-overlay"></div>
                                    <div className="relative z-10">
                                        <div className="bg-black/30 backdrop-blur-md w-fit px-3 py-1 rounded-full text-[10px] font-black uppercase mb-3">SoundCloud Edition</div>
                                        <h1 className="text-4xl md:text-6xl font-black mb-4">Daily Mix</h1>
                                        <p className="text-white/80 max-w-md font-medium mb-6">Fresh tracks curated from the SoundCloud community based on your listening habits.</p>
                                        <button onClick={() => playPlaylist(daily)} className="bg-white text-black px-8 py-3 rounded-full font-bold flex items-center gap-2 hover:scale-105 transition"><Play fill="black" size={20} /> Play Now</button>
                                    </div>
                                </div>
                                <Section title="Trending on SoundCloud" tracks={trending} onPlay={(t) => playPlaylist([t, ...trending])} />
                                <Section title="Made For You" tracks={daily} onPlay={(t) => playPlaylist([t, ...daily])} />
                            </>
                        )}

                        {!loading && (view === "pop" || view === "hiphop" || view === "electronic") && (
                            <div>
                                <h1 className="text-5xl font-black mb-8 capitalize">{view === 'pop' ? 'Top Pop' : view} Charts</h1>
                                <TrackList tracks={trending} onPlay={(t) => playPlaylist(trending, trending.indexOf(t))} />
                            </div>
                        )}

                        {!loading && view === "search" && (
                            <div>
                                <h1 className="text-2xl font-bold mb-6">Search Results</h1>
                                {trending.length > 0 ? <TrackList tracks={trending} onPlay={(t) => playPlaylist(trending, trending.indexOf(t))} /> : <p className="text-gray-500">Search for songs, artists, or genres...</p>}
                            </div>
                        )}
                    </div>
                    <Player />
                </main>
            </div>
        );
      };

      const App = () => (
        <AuthProvider>
            <PlayerProvider>
                <ContentArea />
            </PlayerProvider>
        </AuthProvider>
      );

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
