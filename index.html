
<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>VEX MUSIC</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              jamendo: {
                500: '#8c366c',
                600: '#752d5b',
              },
              spotify: {
                black: '#121212',
                dark: '#181818',
                light: '#282828',
                green: '#1db954',
              }
            },
            animation: {
              'slide-up': 'slideUp 0.3s ease-out forwards',
              'spin-slow': 'spin 8s linear infinite',
            },
            keyframes: {
              slideUp: {
                '0%': { transform: 'translateY(100%)', opacity: '0' },
                '100%': { transform: 'translateY(0)', opacity: '1' },
              }
            }
          }
        }
      }
    </script>

    <!-- Styles -->
    <style>
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: #000; }
      ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: #555; }
      .range-input { -webkit-appearance: none; background: transparent; }
      .range-input::-webkit-slider-thumb { -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%; background: #fff; margin-top: -4px; box-shadow: 0 0 4px rgba(0,0,0,0.5); transition: transform 0.1s; }
      .range-input:hover::-webkit-slider-thumb { transform: scale(1.2); }
      .range-input::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: rgba(255,255,255,0.2); border-radius: 2px; }
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
      .scrolling-text-container { overflow: hidden; white-space: nowrap; }
    </style>

    <!-- Babel for in-browser JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map -->
    <script type="importmap">
{
  "imports": {
    "lucide-react": "https://esm.sh/lucide-react@0.294.0",
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
    "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
    "firebase/database": "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js",
    "react/": "https://esm.sh/react@^19.2.3/",
    "firebase/": "https://esm.sh/firebase@^12.7.0/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
  <body class="bg-black text-white overflow-hidden touch-none h-screen w-screen">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel" data-type="module">
        import React, { createContext, useContext, useState, useEffect, useCallback, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
          Home, Search, Library, PlusSquare, Heart, Globe, Music2, LogIn, LogOut,
          Play, Pause, SkipBack, SkipForward, Repeat, Shuffle, Volume2, Volume1, VolumeX, 
          Maximize2, ChevronDown, Share2, MoreHorizontal, ListMusic, X, GripVertical, 
          Moon, Clock, Download, TrendingUp, History, Sparkles, Coffee, Dumbbell, 
          PartyPopper, CheckCircle, Music, Plus, User, Radio
        } from 'lucide-react';
        import { initializeApp } from "firebase/app";
        import { 
          getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, 
          onAuthStateChanged, signOut 
        } from "firebase/auth";
        import { 
          getDatabase, ref, push, set, onValue 
        } from "firebase/database";

        // --- CONFIG ---
        const CLIENT_ID = '443e1050';
        const API_BASE_URL = 'https://api.jamendo.com/v3.0';
        
        const firebaseConfig = {
          apiKey: "AIzaSyA6jb5U-x8CSFtHCZMVqHaWzLeV98MoWGE",
          authDomain: "studio-3733366627-e5d3d.firebaseapp.com",
          databaseURL: "https://studio-3733366627-e5d3d-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "studio-3733366627-e5d3d",
          storageBucket: "studio-3733366627-e5d3d.firebasestorage.app",
          messagingSenderId: "195800850019",
          appId: "1:195800850019:web:1730ace5541b7a10126256"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- SERVICES ---
        const cache = new Map();
        const CACHE_DURATION = 1000 * 60 * 15;

        const getCached = (key) => {
            const item = cache.get(key);
            if (item && Date.now() - item.timestamp < CACHE_DURATION) return item.data;
            return null;
        };
        const setCache = (key, data) => cache.set(key, { timestamp: Date.now(), data });
        const generateCacheKey = (endpoint, params = {}) => {
            const sortedKeys = Object.keys(params).sort();
            return `${endpoint}?${sortedKeys.map(k => `${k}=${params[k]}`).join('&')}`;
        };

        const fetchJamendo = async (endpoint, params) => {
            const cacheKey = generateCacheKey(`jamendo_${endpoint}`, params);
            const cached = getCached(cacheKey);
            if (cached) return cached;
            
            try {
                const url = new URL(`${API_BASE_URL}${endpoint}`);
                Object.entries({ client_id: CLIENT_ID, format: 'jsonpretty', include: 'musicinfo+stats', limit: '20', ...params })
                    .forEach(([k, v]) => url.searchParams.append(k, v));
                    
                const response = await fetch(url.toString());
                const data = await response.json();
                const tracks = data.results.map((raw) => ({
                    id: raw.id,
                    name: raw.name,
                    duration: raw.duration,
                    artist_id: raw.artist_id,
                    artist_name: raw.artist_name,
                    album_name: raw.album_name,
                    album_id: raw.album_id,
                    album_image: raw.album_image,
                    audio: raw.audio,
                    audiodownload: raw.audiodownload,
                    shareurl: raw.shareurl,
                    image: raw.image,
                    source: 'jamendo',
                    tags: raw.musicinfo?.tags?.tags || []
                }));
                
                if (tracks.length > 0) setCache(cacheKey, tracks);
                return tracks;
            } catch (e) { console.error(e); return []; }
        };

        const getTrendingTracks = (limit = 20) => fetchJamendo('/tracks/', { limit: limit.toString(), boost: 'popularity_week', lang: 'en' });
        const searchJamendo = (query) => fetchJamendo('/tracks/', { search: query });
        const getTracksByTag = (tag, limit = 20) => fetchJamendo('/tracks/', { limit: limit.toString(), tags: tag, boost: 'popularity_month' });
        const getTracksByArtist = (artistId, limit = 20) => fetchJamendo('/tracks/', { limit: limit.toString(), artist_id: artistId, order: 'popularity_total' });

        const SAAVN_BASE_URLS = ['https://saavn.dev.api.avishay.co.il', 'https://saavn.me', 'https://jiosaavn-api-privatecvc2.vercel.app'];

        const mapSaavnToJamendo = (track) => {
          let image = 'https://www.jamendo.com/common/images/track_placeholder.png';
          if (track.image) {
              if (Array.isArray(track.image) && track.image.length > 0) {
                  image = track.image[track.image.length - 1].link || track.image[track.image.length - 1]; 
              } else if (typeof track.image === 'string') {
                  image = track.image;
              }
          }
          image = image.replace('150x150', '500x500').replace('50x50', '500x500');

          let audio = '';
          if (track.downloadUrl) {
              if (Array.isArray(track.downloadUrl) && track.downloadUrl.length > 0) {
                  const last = track.downloadUrl[track.downloadUrl.length - 1];
                  audio = typeof last === 'string' ? last : last.link;
              } else if (typeof track.downloadUrl === 'string') {
                  audio = track.downloadUrl;
              }
          }

          if (!audio) return null;

          const decodeHtml = (html) => {
            if (!html) return '';
            try {
                const txt = document.createElement("textarea");
                txt.innerHTML = html;
                return txt.value;
            } catch { return html; }
          };

          return {
            id: `saavn_${track.id}`,
            name: decodeHtml(track.name),
            duration: typeof track.duration === 'string' ? parseInt(track.duration) : track.duration || 0,
            artist_id: track.primaryArtistsId?.split(',')[0] || '0',
            artist_name: decodeHtml(track.primaryArtists || track.artist || 'Unknown Artist'),
            album_name: decodeHtml(track.album?.name || 'Unknown Album'),
            album_id: track.album?.id || '0',
            album_image: image,
            audio: audio,
            audiodownload: audio,
            shareurl: track.url,
            image: image,
            source: 'saavn',
            tags: [track.language, 'Desi', track.type].filter(Boolean)
          };
        };

        const searchSaavn = async (query) => {
          const cacheKey = generateCacheKey('saavn_search', { query });
          const cached = getCached(cacheKey);
          if (cached) return cached;

          for (const baseUrl of SAAVN_BASE_URLS) {
              try {
                  const res = await fetch(`${baseUrl}/search/songs?query=${encodeURIComponent(query)}&page=1&limit=40`);
                  if (!res.ok) continue;
                  
                  const json = await res.json();
                  let results = [];
                  
                  if (json.status?.toLowerCase() === 'success' || json.status === 'SUCCESS' || json.data) {
                      if (json.data?.results) results = json.data.results;
                      else if (Array.isArray(json.data)) results = json.data;
                  }

                  if (results.length > 0) {
                      const tracks = results.map(mapSaavnToJamendo).filter(t => t !== null);
                      if (tracks.length > 0) {
                          setCache(cacheKey, tracks);
                          return tracks;
                      }
                  }
              } catch (e) { }
          }
          return [];
        };

        const shuffle = (array) => array.sort(() => Math.random() - 0.5);

        const analyzeTasteProfile = (history) => {
            if (history.length === 0) return { topTags: [], topArtists: [], preferredSource: 'mixed', vibe: 'Newcomer' };
            const tagCounts = {};
            const artistCounts = {};
            let jamendoCount = 0, saavnCount = 0;

            history.forEach(track => {
                if (track.source === 'saavn') saavnCount++; else jamendoCount++;
                const artist = track.artist_name.split(',')[0].trim();
                artistCounts[artist] = (artistCounts[artist] || 0) + 1;
                track.tags?.forEach(tag => {
                    const clean = tag.toLowerCase().trim();
                    tagCounts[clean] = (tagCounts[clean] || 0) + 1;
                });
                if (track.source === 'saavn') tagCounts['desi'] = (tagCounts['desi'] || 0) + 1;
            });

            const topTags = Object.entries(tagCounts).sort(([,a], [,b]) => b-a).slice(0,5).map(([t])=>t);
            const topArtists = Object.entries(artistCounts).sort(([,a], [,b]) => b-a).slice(0,3).map(([a])=>a);
            const preferredSource = saavnCount > jamendoCount * 1.5 ? 'saavn' : jamendoCount > saavnCount * 1.5 ? 'jamendo' : 'mixed';
            
            let vibe = 'Eclectic';
            if (topTags.includes('rock') || topTags.includes('metal')) vibe = 'Rocker';
            else if (topTags.includes('lofi') || topTags.includes('chillout')) vibe = 'Chill';
            else if (topTags.includes('desi')) vibe = 'Desi';
            else if (topTags.includes('pop')) vibe = 'Party';

            return { topTags, topArtists, preferredSource, vibe };
        };

        const getDailyMix = async (profile) => {
            const promises = [];
            if (profile.topArtists[0] && profile.preferredSource !== 'jamendo') promises.push(searchSaavn(`${profile.topArtists[0]} radio`));
            if (profile.preferredSource !== 'saavn') {
                const tag = profile.topTags.find((t) => t !== 'desi') || 'pop';
                promises.push(getTracksByTag(tag, 10));
            }
            const results = await Promise.allSettled(promises);
            const tracks = [];
            results.forEach(r => r.status === 'fulfilled' && tracks.push(...r.value));
            return shuffle(tracks).slice(0, 20);
        };

        const getTimeBasedRecommendations = async (profile) => {
            const hour = new Date().getHours();
            const isMorning = hour >= 5 && hour < 12;
            const isNight = hour >= 20 || hour < 5;
            let queries = [];
            
            if (profile.preferredSource !== 'jamendo') {
                if (isMorning) queries.push('Morning Raga', 'Bhakti');
                else if (isNight) queries.push('Hindi Lofi', 'Arijit Singh Sad');
                else queries.push('Bollywood Party', 'Punjabi Hits');
            }
            if (profile.preferredSource !== 'saavn') {
                if (isMorning) queries.push('#acoustic', '#pop');
                else if (isNight) queries.push('#jazz', '#chillout');
                else queries.push('#rock', '#dance');
            }
            
            const query = queries[Math.floor(Math.random() * queries.length)] || 'Top Hits';
            return query.startsWith('#') ? getTracksByTag(query.replace('#', ''), 15) : searchSaavn(query);
        };

        const getMoodTracks = async (mood) => {
            const map = {
                focus: { j: 'classical+soundtrack', s: 'Instrumental Study' },
                relax: { j: 'chillout+ambient', s: 'Slow Hindi Songs' },
                workout: { j: 'rock+electronic', s: 'Gym Workout' },
                party: { j: 'dance+house', s: 'Bollywood Dance' }
            };
            const t = map[mood];
            const [j, s] = await Promise.all([getTracksByTag(t.j, 15), searchSaavn(t.s)]);
            return shuffle([...j, ...s]);
        };

        const getExploreConfig = () => [
            { title: 'New Releases', query: 'New Hindi Songs' },
            { title: 'Top Charts India', query: 'Top 50 India' },
            { title: 'Punjabi Power', query: 'Latest Punjabi Hits' },
            { title: 'Global Viral', query: 'Viral Hits' },
            { title: 'Retro Classics', query: '90s Bollywood' },
            { title: 'Lo-Fi & Chill', query: 'Lofi Hindi' },
            { title: 'Devotional', query: 'Bhakti Songs' }
        ];

        // --- CONTEXTS ---
        const AuthContext = createContext(undefined);
        const useAuth = () => { const c = useContext(AuthContext); if (!c) throw new Error('useAuth error'); return c; };

        const AuthProvider = ({ children }) => {
          const [currentUser, setCurrentUser] = useState(null);
          const [loading, setLoading] = useState(true);
          useEffect(() => onAuthStateChanged(auth, (u) => { setCurrentUser(u); setLoading(false); }), []);
          const logout = () => signOut(auth);
          return <AuthContext.Provider value={{ currentUser, loading, logout }}>{!loading && children}</AuthContext.Provider>;
        };

        const PlayerContext = createContext(undefined);
        const usePlayer = () => { const c = useContext(PlayerContext); if (!c) throw new Error('usePlayer error'); return c; };

        const PlayerProvider = ({ children }) => {
          const [state, setState] = useState({
            currentTrack: null, isPlaying: false, volume: parseFloat(localStorage.getItem('vex_vol') || '1'),
            currentTime: 0, duration: 0, queue: [], history: [], isShuffling: false, repeatMode: 'off'
          });
          const [favorites, setFavorites] = useState([]);
          const [sleepTimerTime, setSleepTimerTime] = useState(null);
          const audioRef = useRef(null);
          const nextTrackRef = useRef(() => {});
          const sleepTimerRef = useRef(null);

          useEffect(() => {
            try {
                const f = localStorage.getItem('vex_favs'); if (f) setFavorites(JSON.parse(f));
                const h = localStorage.getItem('vex_hist'); if (h) setState(p => ({...p, history: JSON.parse(h)}));
            } catch(e) {}
          }, []);

          useEffect(() => {
              if (state.currentTrack) {
                  setState(prev => {
                      if (prev.history[0]?.id === state.currentTrack?.id) return prev;
                      const nh = [state.currentTrack, ...prev.history.filter(t=>t.id!==state.currentTrack?.id)].slice(0,20);
                      localStorage.setItem('vex_hist', JSON.stringify(nh));
                      return { ...prev, history: nh };
                  });
              }
          }, [state.currentTrack]);

          useEffect(() => {
              if (!sleepTimerTime) return;
              const delay = sleepTimerTime - Date.now();
              if (delay <= 0) { setState(p => ({...p, isPlaying: false})); setSleepTimerTime(null); }
              else { 
                  sleepTimerRef.current = window.setTimeout(() => { setState(p => ({...p, isPlaying: false})); setSleepTimerTime(null); }, delay); 
                  return () => { if (sleepTimerRef.current) clearTimeout(sleepTimerRef.current); };
              }
          }, [sleepTimerTime]);

          useEffect(() => {
            const audio = new Audio(); audioRef.current = audio;
            const update = () => setState(p => ({ ...p, currentTime: audio.currentTime }));
            const dur = () => !Number.isNaN(audio.duration) && setState(p => ({ ...p, duration: audio.duration }));
            const end = () => nextTrackRef.current();
            audio.addEventListener('timeupdate', update);
            audio.addEventListener('loadedmetadata', dur);
            audio.addEventListener('ended', end);
            return () => { audio.pause(); audio.removeEventListener('timeupdate', update); audio.removeEventListener('loadedmetadata', dur); audio.removeEventListener('ended', end); };
          }, []);

          useEffect(() => {
              if (!audioRef.current) return;
              audioRef.current.volume = state.volume;
              audioRef.current.loop = state.repeatMode === 'one';
              localStorage.setItem('vex_vol', state.volume.toString());
          }, [state.volume, state.repeatMode]);

          useEffect(() => {
              const audio = audioRef.current;
              if (!audio) return;
              if (state.currentTrack) {
                  if (audio.src !== state.currentTrack.audio) { audio.src = state.currentTrack.audio; audio.load(); }
                  if (state.isPlaying) audio.play().catch(() => {}); else audio.pause();
              } else { audio.pause(); }
          }, [state.currentTrack, state.isPlaying]);

          const playTrack = (t) => setState(p => ({ ...p, currentTrack: t, isPlaying: true, queue: [t] }));
          const playPlaylist = (t, i = 0) => setState(p => ({ ...p, queue: t, currentTrack: t[i], isPlaying: true }));
          const togglePlay = () => setState(p => p.currentTrack ? { ...p, isPlaying: !p.isPlaying } : p);
          const setVolume = (v) => setState(p => ({ ...p, volume: v }));
          const seek = (t) => { if (audioRef.current) { audioRef.current.currentTime = t; setState(p => ({ ...p, currentTime: t })); } };
          const toggleShuffle = () => setState(p => ({ ...p, isShuffling: !p.isShuffling }));
          const toggleRepeat = () => setState(p => ({ ...p, repeatMode: p.repeatMode === 'off' ? 'all' : p.repeatMode === 'all' ? 'one' : 'off' }));
          const addToQueue = (t) => setState(p => ({ ...p, queue: [...p.queue, t] }));
          const removeFromQueue = (i) => setState(p => { const q = [...p.queue]; q.splice(i, 1); return { ...p, queue: q }; });
          const reorderQueue = (f, t) => setState(p => { const q = [...p.queue]; const [rm] = q.splice(f, 1); q.splice(t, 0, rm); return { ...p, queue: q }; });
          
          const nextTrack = useCallback(() => {
              setState(p => {
                  if (!p.currentTrack || !p.queue.length) return p;
                  const curr = p.queue.findIndex(t => t.id === p.currentTrack?.id);
                  let next = curr + 1;
                  if (p.isShuffling) next = Math.floor(Math.random() * p.queue.length);
                  else if (next >= p.queue.length) { if (p.repeatMode === 'all') next = 0; else return { ...p, isPlaying: false }; }
                  return { ...p, currentTrack: p.queue[next], isPlaying: true };
              });
          }, []);
          
          const prevTrack = useCallback(() => {
              if (audioRef.current && audioRef.current.currentTime > 3) { audioRef.current.currentTime = 0; return; }
              setState(p => {
                  if (!p.currentTrack || !p.queue.length) return p;
                  const curr = p.queue.findIndex(t => t.id === p.currentTrack?.id);
                  let prev = curr - 1;
                  if (prev < 0) prev = p.queue.length - 1;
                  return { ...p, currentTrack: p.queue[prev], isPlaying: true };
              });
          }, []);
          
          const toggleFavorite = (t) => setFavorites(prev => {
              const exists = prev.some(x => x.id === t.id);
              const nf = exists ? prev.filter(x => x.id !== t.id) : [...prev, t];
              localStorage.setItem('vex_favs', JSON.stringify(nf));
              return nf;
          });

          useEffect(() => { nextTrackRef.current = nextTrack; }, [nextTrack]);

          return (
            <PlayerContext.Provider value={{ ...state, playTrack, playPlaylist, togglePlay, nextTrack, prevTrack, seek, setVolume, toggleShuffle, toggleRepeat, addToQueue, removeFromQueue, reorderQueue, favorites, toggleFavorite, isFavorite: (id) => favorites.some(t => t.id === id), setSleepTimer: (m) => setSleepTimerTime(m ? Date.now() + m * 60000 : null), sleepTimerTime }}>
                {children}
            </PlayerContext.Provider>
          );
        };

        // --- COMPONENTS ---
        const Sidebar = ({ currentView, onChangeView, onCreatePlaylist }) => {
            const { currentUser, logout } = useAuth();
            return (
                <div className="hidden md:flex w-64 bg-black h-full flex-col flex-shrink-0 text-gray-400 font-medium z-40 border-r border-[#222]">
                    <div className="p-6"><h1 className="text-white text-2xl font-black tracking-tight flex items-center gap-2"><div className="bg-jamendo-500 rounded p-1"><Globe className="text-white" size={24} /></div><span>VEX MUSIC</span></h1></div>
                    <nav className="flex-1 px-3 space-y-1 overflow-y-auto">
                        {[{id:'home',icon:<Home size={22}/>,l:'Home'},{id:'search',icon:<Search size={22}/>,l:'Search'},{id:'library',icon:<Library size={22}/>,l:'Library'}]
                        .map(i => <button key={i.id} onClick={() => onChangeView(i.id)} className={`w-full flex items-center gap-4 px-4 py-3 rounded-lg transition-all duration-200 font-bold ${currentView===i.id?'bg-[#222] text-white':'hover:text-white hover:bg-[#111]'}`}>{i.icon}<span>{i.l}</span></button>)}
                        
                        <div className="px-4 mb-2 mt-6 text-[10px] font-black uppercase tracking-widest text-gray-600">Discover Desi</div>
                        {[{id:'hindi',l:'Hindi Hits'},{id:'bangla',l:'Bangla Beats'}].map(i => <button key={i.id} onClick={() => onChangeView(i.id)} className={`w-full flex items-center gap-4 px-4 py-3 rounded-lg transition-all duration-200 ${currentView===i.id?'bg-[#222] text-white':'hover:text-white hover:bg-[#111]'}`}><Radio size={22}/><span>{i.l}</span></button>)}
                        
                        <div className="mt-auto pt-6 border-t border-[#222] px-2 space-y-2">
                            <button onClick={() => onChangeView('liked')} className={`w-full flex items-center gap-4 px-4 py-3 rounded-lg transition-all group ${currentView==='liked'?'bg-[#222] text-white':'hover:text-white'}`}><div className="bg-gradient-to-br from-indigo-700 to-blue-300 rounded-sm p-1 text-white group-hover:scale-110 transition"><Heart size={18} fill="white"/></div><span>Liked Songs</span></button>
                            <button onClick={onCreatePlaylist} className="w-full flex items-center gap-4 px-4 py-3 rounded-lg hover:text-white transition-all group"><div className="bg-gray-300 rounded-sm p-1 text-black group-hover:scale-110 transition"><PlusSquare size={18}/></div><span>Create Playlist</span></button>
                        </div>
                    </nav>
                    <div className="px-6 py-6 border-t border-[#222]">
                        {currentUser ? <div className="flex flex-col gap-3"><div className="text-xs text-gray-500 font-bold uppercase tracking-wider">Logged in as</div><div className="text-sm font-bold text-white truncate">{currentUser.email}</div><button onClick={logout} className="flex items-center gap-2 text-red-500 hover:text-red-400 text-sm font-bold transition mt-2"><LogOut size={16}/> Logout</button></div> : <button onClick={() => onChangeView('auth')} className="w-full py-3 bg-white text-black font-bold rounded-full hover:scale-105 transition flex items-center justify-center gap-2"><LogIn size={18}/> Login</button>}
                    </div>
                </div>
            );
        };

        const MobileNav = ({ currentView, onChangeView }) => (
            <div className="md:hidden fixed bottom-0 left-0 w-full bg-black/95 backdrop-blur-xl border-t border-[#222] z-50 px-6 py-3 flex justify-between items-center text-[10px] font-bold text-gray-500 pb-safe">
                {[{id:'home',I:Home,l:'Home'},{id:'search',I:Search,l:'Search'},{id:'liked',I:Heart,l:'Liked'},{id:'library',I:Library,l:'Library'}].map(x => (
                    <button key={x.id} onClick={() => onChangeView(x.id)} className={`flex flex-col items-center gap-1 transition ${currentView===x.id?'text-white scale-110':''}`}>
                        <x.I size={24} fill={currentView===x.id && x.id!=='search'&&x.id!=='library'?"currentColor":"none"} color={currentView===x.id?"white":"currentColor"}/><span>{x.l}</span>
                    </button>
                ))}
            </div>
        );

        const SearchBar = ({ onSearch, initialQuery='' }) => {
            const [q, setQ] = useState(initialQuery);
            const [f, setF] = useState(false);
            const [rec, setRec] = useState([]);
            const rRef = useRef(null);
            
            useEffect(() => { setQ(initialQuery); }, [initialQuery]);
            useEffect(() => { try { const s = localStorage.getItem('vex_rec_search'); if(s) setRec(JSON.parse(s)); } catch{} }, []);
            useEffect(() => { const t = setTimeout(() => { if(q.trim()) onSearch(q); }, 500); return () => clearTimeout(t); }, [q, onSearch]);
            useEffect(() => { const h = (e) => { if(rRef.current && !rRef.current.contains(e.target)) setF(false); }; document.addEventListener('mousedown', h); return () => document.removeEventListener('mousedown', h); }, []);
            
            const addR = (t) => { const n = [t, ...rec.filter(x=>x!==t)].slice(0,5); setRec(n); localStorage.setItem('vex_rec_search', JSON.stringify(n)); };
            const click = (t) => { setQ(t); setF(false); onSearch(t); addR(t); };
            return (
                <div className="relative w-full max-w-md" ref={rRef}>
                    <div className="absolute inset-y-0 left-0 flex items-center pl-4 pointer-events-none text-gray-400"><Search size={18}/></div>
                    <input type="text" className="w-full bg-[#282828] text-white rounded-full py-3 pl-12 pr-4 focus:outline-none focus:bg-[#333] focus:ring-1 focus:ring-white/20 font-medium placeholder-gray-500 transition-all text-sm" placeholder="What do you want to listen to?" value={q} onChange={e=>setQ(e.target.value)} onFocus={()=>setF(true)} onKeyDown={e=>{if(e.key==='Enter'&&q.trim()){setF(false);addR(q);onSearch(q);}}} />
                    {f && (rec.length>0 || q) && (
                        <div className="absolute top-full left-0 right-0 mt-2 bg-[#282828] rounded-xl shadow-2xl overflow-hidden z-50 border border-white/10">
                            <div className="py-2">
                                {rec.length > 0 && <div className="px-4 py-2 text-[10px] font-black text-gray-500 uppercase tracking-widest">Recent Searches</div>}
                                {rec.map(t => <div key={t} onClick={()=>click(t)} className="px-4 py-3 hover:bg-[#3E3E3E] cursor-pointer flex justify-between group text-white text-sm"><div className="flex items-center gap-3"><History size={16} className="text-gray-400"/><span>{t}</span></div><button onClick={(e)=>{e.stopPropagation();const n=rec.filter(x=>x!==t);setRec(n);localStorage.setItem('vex_rec_search',JSON.stringify(n))}} className="text-gray-500 hover:text-white opacity-0 group-hover:opacity-100 transition"><X size={14}/></button></div>)}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const TrackList = ({ tracks, onPlay, onArtistClick, title, showCover=true }) => {
            const { currentTrack, isPlaying, toggleFavorite, isFavorite } = usePlayer();
            const format = (s) => `${Math.floor(s/60)}:${Math.floor(s%60).toString().padStart(2,'0')}`;
            return (
                <div className="w-full pb-32 md:pb-12">
                    {title && <h2 className="text-2xl font-bold mb-6 text-white px-4 md:px-0">{title}</h2>}
                    <div className="hidden md:grid grid-cols-[24px_4fr_3fr_minmax(60px,1fr)] gap-4 px-4 py-2 border-b border-white/10 text-gray-400 text-xs font-bold uppercase tracking-wider sticky top-[64px] bg-[#121212]/95 backdrop-blur-md z-10 mb-2"><div>#</div><div>Title</div><div>Album</div><div className="flex justify-end"><Clock size={14}/></div></div>
                    <div className="space-y-0.5">
                        {tracks.map((t, i) => {
                            const active = currentTrack?.id === t.id;
                            return (
                                <div key={t.id} onClick={() => onPlay(t, tracks)} className={`group grid grid-cols-[auto_1fr] md:grid-cols-[24px_4fr_3fr_minmax(60px,1fr)] gap-4 px-4 py-2 md:py-2.5 rounded-lg items-center cursor-pointer transition duration-200 ${active ? 'bg-white/10' : 'hover:bg-white/5'}`}>
                                    <div className="hidden md:flex items-center justify-center w-6">{active && isPlaying ? <div className="flex gap-[2px] items-end h-3"><span className="w-0.5 bg-jamendo-500 h-2 animate-pulse"/><span className="w-0.5 bg-jamendo-500 h-3 animate-pulse delay-75"/><span className="w-0.5 bg-jamendo-500 h-1 animate-pulse delay-150"/></div> : <span className="text-gray-500 group-hover:hidden text-sm font-medium">{i+1}</span>}<Play size={14} fill="white" className={`hidden text-white ${active && isPlaying ? 'hidden' : 'group-hover:block'}`}/></div>
                                    <div className="flex items-center gap-4 overflow-hidden">
                                        {showCover && <div className="relative w-10 h-10 md:w-10 md:h-10 flex-shrink-0"><img src={t.album_image} alt="" className={`w-full h-full rounded object-cover shadow-lg ${active?'opacity-50':''}`}/>{active && <div className="absolute inset-0 flex items-center justify-center"><div className="flex items-end gap-[2px] h-3"><span className="w-1 bg-jamendo-500 h-full animate-pulse"/></div></div>}</div>}
                                        <div className="flex flex-col overflow-hidden justify-center">
                                            <span className={`truncate font-bold text-sm mb-0.5 ${active ? 'text-jamendo-500' : 'text-white'}`}>{t.name}</span>
                                            <span onClick={e => { e.stopPropagation(); onArtistClick?.(t.artist_id, t.artist_name); }} className="text-xs text-gray-400 truncate hover:underline hover:text-white cursor-pointer w-fit">{t.artist_name}</span>
                                        </div>
                                    </div>
                                    <div className="hidden md:block truncate text-xs text-gray-400 font-medium hover:text-white hover:underline cursor-pointer">{t.album_name}</div>
                                    <div className="flex items-center justify-end gap-4 text-xs font-medium text-gray-400">
                                        <button onClick={e => { e.stopPropagation(); toggleFavorite(t); }} className={`hover:scale-110 transition ${isFavorite(t.id) ? 'text-jamendo-500' : 'text-gray-500 hover:text-white opacity-0 group-hover:opacity-100'}`}><Heart size={16} fill={isFavorite(t.id) ? "currentColor" : "none"}/></button>
                                        <span className="hidden md:block tabular-nums">{format(t.duration)}</span>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const Section = ({ title, subtitle, tracks, onPlay, onArtistClick }) => {
            if (!tracks || tracks.length === 0) return null;
            return (
                <div className="mb-10 px-4 md:px-0 animate-slide-up">
                    <div className="mb-4">
                        <h2 className="text-2xl font-bold text-white tracking-tight">{title}</h2>
                        {subtitle && <p className="text-sm text-gray-400 mt-1">{subtitle}</p>}
                    </div>
                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6">
                        {tracks.slice(0, 5).map(track => (
                            <div key={track.id} onClick={() => onPlay(track)} className="group bg-[#181818] hover:bg-[#282828] p-4 rounded-lg transition-all duration-300 cursor-pointer hover:-translate-y-2 hover:shadow-xl">
                                <div className="relative mb-4 aspect-square shadow-black/50 shadow-lg rounded-md overflow-hidden">
                                    <img src={track.album_image} className="w-full h-full object-cover group-hover:scale-105 transition duration-500"/>
                                    <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-all duration-300 flex items-center justify-center translate-y-4 group-hover:translate-y-0">
                                        <div className="bg-jamendo-500 rounded-full p-3.5 text-white shadow-xl hover:scale-105 transition transform"><Play fill="currentColor" size={24} className="ml-1"/></div>
                                    </div>
                                </div>
                                <h3 className="font-bold text-white truncate mb-1 text-sm">{track.name}</h3>
                                <p onClick={e => { e.stopPropagation(); onArtistClick(track.artist_id, track.artist_name); }} className="text-xs text-gray-400 truncate hover:underline hover:text-white font-medium">{track.artist_name}</p>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const Player = () => {
          const { currentTrack, isPlaying, togglePlay, nextTrack, prevTrack, volume, setVolume, currentTime, duration, seek, toggleShuffle, toggleRepeat, isShuffling, repeatMode, queue, removeFromQueue, setSleepTimer, sleepTimerTime, toggleFavorite, isFavorite } = usePlayer();
          const [full, setFull] = useState(false);
          const [qOpen, setQOpen] = useState(false);
          const [more, setMore] = useState(false);
          const mRef = useRef(null);
          
          useEffect(() => { const h = (e) => { if (mRef.current && !mRef.current.contains(e.target)) setMore(false); }; if(more) document.addEventListener('mousedown', h); return () => document.removeEventListener('mousedown', h); }, [more]);
          if (!currentTrack) return null;
          const progress = duration ? (currentTime / duration) * 100 : 0;
          const fmt = (t) => `${Math.floor(t/60)}:${Math.floor(t%60).toString().padStart(2,'0')}`;

          const Queue = () => (
              <div className="flex flex-col h-full bg-[#121212] text-white p-6 overflow-y-auto">
                  <div className="flex justify-between items-center mb-8"><h2 className="text-2xl font-bold">Queue</h2><button onClick={()=>setQOpen(false)} className="md:hidden p-2 bg-white/10 rounded-full"><ChevronDown/></button></div>
                  <div className="mb-8"><h3 className="text-xs font-black text-gray-500 mb-3 uppercase tracking-widest">Now Playing</h3><div className="flex items-center gap-4 p-3 bg-white/5 rounded-lg border border-jamendo-500/30"><img src={currentTrack.album_image} className="w-12 h-12 rounded object-cover shadow-lg"/><div className="flex-1 min-w-0"><p className="text-jamendo-500 font-bold truncate">{currentTrack.name}</p><p className="text-xs text-gray-400 font-medium truncate">{currentTrack.artist_name}</p></div><div className="flex gap-1 h-4 items-end mr-2"><div className="w-1 bg-jamendo-500 animate-pulse h-full"/><div className="w-1 bg-jamendo-500 animate-pulse delay-75 h-2/3"/><div className="w-1 bg-jamendo-500 animate-pulse delay-150 h-1/2"/></div></div></div>
                  <div><h3 className="text-xs font-black text-gray-500 mb-3 uppercase tracking-widest">Next Up</h3><div className="space-y-1">{queue.map((t, i) => { if(t.id === currentTrack.id) return null; return ( <div key={`${t.id}-${i}`} className="flex items-center gap-4 p-2 rounded-lg hover:bg-white/5 group"><GripVertical size={16} className="text-gray-700"/><img src={t.album_image} className="w-10 h-10 rounded object-cover opacity-80 group-hover:opacity-100"/><div className="flex-1 min-w-0"><p className="text-sm font-medium text-white truncate">{t.name}</p><p className="text-xs text-gray-400 truncate">{t.artist_name}</p></div><button onClick={()=>removeFromQueue(i)} className="text-gray-500 hover:text-white opacity-0 group-hover:opacity-100"><X size={16}/></button></div> ); })}</div></div>
              </div>
          );

          if (full) return (
              <div className="fixed inset-0 z-[100] bg-black/95 backdrop-blur-3xl flex flex-col text-white md:hidden animate-slide-up pb-safe">
                  <div className="absolute inset-0 z-0 opacity-30 blur-3xl scale-150 pointer-events-none" style={{backgroundImage: `url(${currentTrack.album_image})`, backgroundSize: 'cover', backgroundPosition: 'center'}}/>
                  <div className="relative z-10 flex flex-col h-full">
                    <div className="flex items-center justify-between p-6"><button onClick={()=>{setFull(false);setQOpen(false)}} className="p-2"><ChevronDown size={28}/></button><span className="text-[10px] font-black tracking-widest uppercase text-gray-300">{qOpen?'Queue':'Now Playing'}</span><button onClick={()=>setQOpen(!qOpen)} className={`p-2 ${qOpen?'text-jamendo-500':'text-white'}`}><ListMusic size={24}/></button></div>
                    {qOpen ? <div className="flex-1 overflow-hidden"><Queue/></div> : (
                        <div className="flex-1 flex flex-col px-8 py-4 overflow-y-auto no-scrollbar justify-center">
                            <div className="w-full aspect-square mb-10 shadow-[0_20px_50px_rgba(0,0,0,0.5)] rounded-2xl overflow-hidden mx-auto max-w-[350px] border border-white/10"><img src={currentTrack.album_image.replace('1.200','1.500')} className="w-full h-full object-cover"/></div>
                            <div className="mb-10"><h2 className="text-3xl font-black truncate mb-2 leading-tight">{currentTrack.name}</h2><p className="text-gray-300 text-lg font-medium truncate">{currentTrack.artist_name}</p></div>
                            <div className="mb-8"><div className="relative h-1.5 bg-white/20 rounded-full mb-3"><div className="absolute h-full bg-white rounded-full" style={{width:`${progress}%`}}/><input type="range" min="0" max="100" value={progress||0} onChange={e=>seek((Number(e.target.value)/100)*duration)} className="absolute w-full h-full opacity-0 z-10"/></div><div className="flex justify-between text-xs font-bold text-gray-400"><span>{fmt(currentTime)}</span><span>{fmt(duration)}</span></div></div>
                            <div className="flex items-center justify-between mb-10"><button onClick={toggleShuffle} className={isShuffling?'text-jamendo-500':'text-gray-400'}><Shuffle size={24}/></button><button onClick={prevTrack} className="hover:scale-110 transition"><SkipBack size={36} fill="white"/></button><button onClick={togglePlay} className="w-20 h-20 bg-white text-black rounded-full flex items-center justify-center hover:scale-105 transition shadow-[0_0_20px_rgba(255,255,255,0.3)]"><div className="ml-1">{isPlaying?<Pause size={32} fill="black" className="-ml-1"/>:<Play size={32} fill="black"/>}</div></button><button onClick={nextTrack} className="hover:scale-110 transition"><SkipForward size={36} fill="white"/></button><button onClick={toggleRepeat} className={repeatMode!=='off'?'text-jamendo-500':'text-gray-400'}><Repeat size={24}/></button></div>
                            <div className="flex justify-center pb-4 relative"><button onClick={()=>setMore(!more)} className="text-gray-400 p-2"><MoreHorizontal/></button>{more && <div ref={mRef} className="absolute bottom-16 bg-[#222] p-4 rounded-xl border border-white/10 w-64 shadow-2xl z-50"><div className="text-[10px] font-black text-gray-500 mb-3 uppercase tracking-widest">Sleep Timer</div><div className="grid grid-cols-4 gap-2 mb-2">{[5,15,30,60].map(m=><button key={m} onClick={()=>{setSleepTimer(m);setMore(false)}} className="bg-white/10 hover:bg-jamendo-500 text-xs font-bold py-2 rounded transition">{m}m</button>)}</div>{sleepTimerTime && <button onClick={()=>{setSleepTimer(null);setMore(false)}} className="text-red-400 text-xs font-bold mt-2 block w-full text-center py-2 hover:bg-white/5 rounded">Stop Timer</button>}</div>}</div>
                        </div>
                    )}
                  </div>
              </div>
          );

          return (
              <>
                {qOpen && <div className="hidden md:block fixed bottom-24 right-6 w-96 max-h-[calc(100vh-140px)] bg-[#121212]/95 backdrop-blur-xl rounded-xl shadow-2xl z-50 border border-white/10 overflow-hidden flex flex-col animate-slide-up"><Queue/></div>}
                <div onClick={()=>setFull(true)} className="md:hidden fixed bottom-[60px] left-3 right-3 h-16 bg-[#222]/90 backdrop-blur-md rounded-xl flex items-center px-3 shadow-2xl z-50 border border-white/10"><img src={currentTrack.album_image} className={`h-10 w-10 rounded-md object-cover mr-3 shadow-md ${isPlaying?'animate-[spin_10s_linear_infinite]':''}`} style={{animationPlayState:isPlaying?'running':'paused'}}/><div className="flex-1 overflow-hidden min-w-0 flex flex-col justify-center mr-2"><span className="text-white font-bold text-sm truncate">{currentTrack.name}</span><span className="text-gray-400 text-xs truncate">{currentTrack.artist_name}</span></div><button onClick={e=>{e.stopPropagation();togglePlay()}} className="text-white p-3">{isPlaying?<Pause size={24} fill="white"/>:<Play size={24} fill="white"/>}</button><div className="absolute bottom-0 left-3 right-3 h-[2px] bg-white/10 rounded-full overflow-hidden"><div className="h-full bg-jamendo-500" style={{width:`${progress}%`}}/></div></div>
                <div className="hidden md:grid h-24 bg-black/90 backdrop-blur-xl border-t border-white/5 px-6 grid-cols-3 items-center fixed bottom-0 left-0 right-0 z-[60] text-white shadow-2xl">
                    <div className="flex items-center gap-4 min-w-0 overflow-hidden group">
                        <div className="relative">
                            <img src={currentTrack.album_image} className={`h-14 w-14 rounded-md shadow-lg transition-all duration-700 ${isPlaying?'':''}`}/>
                            <button onClick={()=>setFull(true)} className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 flex items-center justify-center transition rounded-md"><Maximize2 size={20}/></button>
                        </div>
                        <div className="flex flex-col min-w-0 overflow-hidden"><span className="font-bold text-sm truncate hover:underline cursor-pointer">{currentTrack.name}</span><span className="text-xs text-gray-400 font-medium truncate hover:text-white cursor-pointer">{currentTrack.artist_name}</span></div>
                        <button onClick={()=>toggleFavorite(currentTrack)} className={`ml-2 ${isFavorite(currentTrack.id)?'text-jamendo-500':'text-gray-500 hover:text-white'}`}><Heart size={18} fill={isFavorite(currentTrack.id)?"currentColor":"none"}/></button>
                    </div>
                    <div className="flex flex-col items-center max-w-md mx-auto w-full">
                        <div className="flex items-center gap-6 mb-1.5">
                            <button onClick={toggleShuffle} className={`transition ${isShuffling?'text-jamendo-500 dot-indicator':'text-gray-400 hover:text-white'}`}><Shuffle size={18}/></button>
                            <button onClick={prevTrack} className="text-gray-300 hover:text-white transition hover:scale-110"><SkipBack size={24} fill="currentColor"/></button>
                            <button onClick={togglePlay} className="w-9 h-9 bg-white rounded-full flex items-center justify-center text-black hover:scale-105 transition shadow-lg">{isPlaying?<Pause size={20} fill="black"/>:<Play size={20} fill="black" className="ml-0.5"/>}</button>
                            <button onClick={nextTrack} className="text-gray-300 hover:text-white transition hover:scale-110"><SkipForward size={24} fill="currentColor"/></button>
                            <button onClick={toggleRepeat} className={`relative transition ${repeatMode!=='off'?'text-jamendo-500':'text-gray-400 hover:text-white'}`}><Repeat size={18}/>{repeatMode==='one'&&<span className="absolute -top-1 -right-1 text-[8px] bg-[#222] border border-gray-600 rounded-full w-3 h-3 flex items-center justify-center">1</span>}</button>
                        </div>
                        <div className="flex w-full items-center gap-2 text-xs font-medium text-gray-500 font-mono">
                            <span className="w-8 text-right">{fmt(currentTime)}</span>
                            <div className="relative flex-1 h-1 bg-white/10 rounded-full group cursor-pointer"><div className="absolute h-full bg-white group-hover:bg-jamendo-500 rounded-full transition-colors" style={{width:`${progress}%`}}/><input type="range" min="0" max="100" value={progress||0} onChange={e=>seek((Number(e.target.value)/100)*duration)} className="absolute w-full h-full opacity-0 z-10"/></div>
                            <span className="w-8">{fmt(duration)}</span>
                        </div>
                    </div>
                    <div className="flex items-center justify-end gap-3">
                        <button onClick={()=>setMore(!more)} className={`p-2 rounded-full hover:bg-white/10 ${more?'text-white':'text-gray-400'}`}><MoreHorizontal size={18}/></button>
                        <button onClick={()=>setQOpen(!qOpen)} className={`p-2 rounded-full hover:bg-white/10 ${qOpen?'text-jamendo-500':'text-gray-400'}`}><ListMusic size={18}/></button>
                        <div className="flex items-center gap-2 w-28 group">
                            <button onClick={()=>setVolume(volume===0?0.5:0)} className="text-gray-400 hover:text-white">{volume===0?<VolumeX size={18}/>:<Volume2 size={18}/>}</button>
                            <div className="relative flex-1 h-1 bg-white/10 rounded-full overflow-hidden"><div className="absolute h-full bg-gray-400 group-hover:bg-white rounded-full" style={{width:`${volume*100}%`}}/><input type="range" min="0" max="1" step="0.01" value={volume} onChange={e=>setVolume(Number(e.target.value))} className="absolute w-full h-full opacity-0 z-10 cursor-pointer"/></div>
                        </div>
                        {more && <div ref={mRef} className="absolute bottom-28 right-8 bg-[#222] p-4 rounded-xl border border-white/10 w-56 shadow-2xl z-50"><div className="text-[10px] font-black text-gray-500 mb-3 uppercase tracking-widest">Sleep Timer</div><div className="grid grid-cols-4 gap-2">{[5,15,30,60].map(m=><button key={m} onClick={()=>{setSleepTimer(m);setMore(false)}} className="bg-white/10 hover:bg-jamendo-500 text-xs font-bold py-1.5 rounded transition">{m}m</button>)}</div>{sleepTimerTime && <button onClick={()=>{setSleepTimer(null);setMore(false)}} className="text-red-400 text-xs font-bold mt-2 block w-full text-center py-2 hover:bg-white/5 rounded">Stop Timer</button>}</div>}
                    </div>
                </div>
              </>
          );
        };

        const AuthForm = ({ onSuccess }) => {
            const [login, setLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [pass, setPass] = useState('');
            const [err, setErr] = useState('');

            const sub = async (e) => {
                e.preventDefault(); setErr('');
                try {
                    if (login) await signInWithEmailAndPassword(auth, email, pass);
                    else await createUserWithEmailAndPassword(auth, email, pass);
                    onSuccess();
                } catch (e) { setErr(e.message); }
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-[60vh] max-w-sm mx-auto px-4">
                    <h2 className="text-4xl font-black mb-8 tracking-tight">{login?'Welcome Back':'Join Vex'}</h2>
                    <form onSubmit={sub} className="w-full space-y-4">
                        <input type="email" placeholder="Email" className="w-full p-4 rounded-lg bg-[#222] text-white outline-none focus:ring-2 ring-jamendo-500 font-medium" value={email} onChange={e=>setEmail(e.target.value)} required/>
                        <input type="password" placeholder="Password" className="w-full p-4 rounded-lg bg-[#222] text-white outline-none focus:ring-2 ring-jamendo-500 font-medium" value={pass} onChange={e=>setPass(e.target.value)} required/>
                        {err && <p className="text-red-500 text-sm font-bold">{err}</p>}
                        <button type="submit" className="w-full bg-jamendo-500 hover:bg-jamendo-600 text-white font-bold py-4 rounded-full transition shadow-lg shadow-jamendo-500/30">{login?'Log In':'Sign Up'}</button>
                    </form>
                    <p className="mt-6 text-gray-400 text-sm">{login?"Don't have an account? ":"Already have an account? "}<button onClick={()=>setLogin(!login)} className="text-white font-bold hover:underline">{login?'Sign Up':'Log In'}</button></p>
                </div>
            );
        };

        const ContentArea = () => {
          const [view, setView] = useState('home'); 
          const [query, setQuery] = useState('');
          const [trending, setTrending] = useState([]);
          const [daily, setDaily] = useState([]);
          const [timeRec, setTimeRec] = useState([]);
          const [explore, setExplore] = useState([]);
          const [moodList, setMoodList] = useState([]);
          const [topRes, setTopRes] = useState(null);
          const [loading, setLoading] = useState(false); 
          const [heroLoad, setHeroLoad] = useState(true);
          const [greet, setGreet] = useState('');
          const [vibe, setVibe] = useState('Newcomer');
          const [selMood, setSelMood] = useState(null);
          const [artist, setArtist] = useState(null);
          const [playlists, setPlaylists] = useState([]);
          const [selPl, setSelPl] = useState(null);
          const loaded = useRef(false);

          const { playPlaylist, favorites, history } = usePlayer();
          const { currentUser } = useAuth();

          useEffect(() => {
            const h = new Date().getHours();
            setGreet(h<5?'Good Late Night':h<12?'Good Morning':h<18?'Good Afternoon':'Good Evening');
          }, []);

          useEffect(() => { if (view==='home' && !loaded.current) { loadHome(); loaded.current = true; } }, [view]);

          useEffect(() => {
              if (currentUser) {
                  return onValue(ref(db, `users/${currentUser.uid}/playlists`), s => {
                      const d = s.val();
                      setPlaylists(d ? Object.keys(d).map(k => ({ id: k, ...d[k] })) : []);
                  });
              } else setPlaylists([]);
          }, [currentUser]);

          const createPl = async () => {
              if (!currentUser) return setView('auth');
              const n = prompt("Enter playlist name:");
              if (n) await set(push(ref(db, `users/${currentUser.uid}/playlists`)), { name: n, createdAt: Date.now(), tracks: [] });
          };

          const loadHome = async () => {
              try {
                  const p = analyzeTasteProfile(history);
                  setVibe(p.vibe);
                  getDailyMix(p).then(d => { setDaily(d); setHeroLoad(false); });
                  getTrendingTracks(15).then(setTrending);
                  getTimeBasedRecommendations(p).then(setTimeRec);
                  const conf = getExploreConfig();
                  for (const c of conf) {
                      const t = await searchSaavn(c.query);
                      if (t.length) setExplore(prev => [...prev, { title: c.title, tracks: t }]);
                  }
              } catch { setHeroLoad(false); }
          };

          const onMood = async (m) => {
              if (selMood === m) return setSelMood(null);
              setSelMood(m); setLoading(true);
              try { setMoodList(await getMoodTracks(m)); } catch{}
              setLoading(false);
          };

          const onSearch = useCallback(async (q) => {
            setQuery(q); if (!q) return;
            setLoading(true); setView('search'); setTopRes(null); setTrending([]);
            try {
                const [j, s] = await Promise.allSettled([searchJamendo(q), searchSaavn(q)]);
                const jd = j.status==='fulfilled'?j.value:[];
                const sd = s.status==='fulfilled'?s.value:[];
                if (sd.length) { setTopRes(sd[0]); setTrending([...sd.slice(1), ...jd]); }
                else { setTopRes(jd[0]); setTrending(jd.slice(1)); }
            } catch{}
            setLoading(false);
          }, []);

          const onArtistClick = async (id, name) => {
              if (id.startsWith('saavn_')) {
                  setQuery(name); setView('search'); setLoading(true);
                  const d = await searchSaavn(name);
                  setTopRes(d[0]||null); setTrending(d.slice(1)); setLoading(false);
              } else {
                  setArtist({id,name}); setView('artist'); setLoading(true);
                  setTrending(await getTracksByArtist(id, 30)); setTopRes(null); setLoading(false);
              }
          };

          const onPlay = (t, list) => {
              if (topRes && t.id === topRes.id) playPlaylist([topRes, ...trending], 0);
              else {
                  const q = topRes && view==='search' ? [topRes, ...list] : list;
                  playPlaylist(q, q.findIndex(x => x.id === t.id));
              }
          };

          const render = () => {
            if (loading && view!=='home') return <div className="flex flex-col items-center justify-center h-96 text-gray-500 animate-pulse gap-4"><div className="w-16 h-16 bg-[#222] rounded-full"/><div className="h-4 w-32 bg-[#222] rounded"/><div className="h-3 w-24 bg-[#222] rounded"/></div>;
            
            if (view === 'auth') return <div className="pt-20"><AuthForm onSuccess={()=>setView('home')}/></div>;

            if (view === 'library') {
                if (!currentUser) return <div className="flex flex-col items-center justify-center h-96 text-center px-4"><div className="bg-[#222] p-8 rounded-full mb-6"><User size={64} className="text-gray-500"/></div><h2 className="text-3xl font-black mb-2 tracking-tight">Your Library</h2><p className="text-gray-500 mb-6">Login to see your playlists and favorites.</p><button onClick={()=>setView('auth')} className="bg-white text-black font-bold py-3 px-8 rounded-full hover:scale-105 transition shadow-lg">Log In</button></div>;
                return (
                    <div className="px-6 md:px-8 pt-10">
                        <div className="flex items-center justify-between mb-10"><h1 className="text-4xl font-black tracking-tight">Your Library</h1><button onClick={createPl} className="flex items-center gap-2 bg-jamendo-500 hover:bg-jamendo-600 px-6 py-3 rounded-full font-bold transition shadow-lg shadow-jamendo-500/20"><Plus size={20}/> New Playlist</button></div>
                        <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6">
                            <div onClick={()=>setView('liked')} className="bg-gradient-to-br from-indigo-700 to-blue-500 p-6 rounded-2xl aspect-square flex flex-col justify-end cursor-pointer hover:scale-105 transition duration-300 shadow-xl group relative overflow-hidden"><div className="absolute top-0 right-0 p-8 opacity-20"><Heart size={100} fill="white"/></div><div className="relative z-10"><h3 className="font-black text-2xl mb-1">Liked Songs</h3><p className="text-sm text-indigo-200 font-medium">{favorites.length} songs</p></div><div className="absolute right-4 bottom-4 bg-jamendo-500 rounded-full p-4 shadow-lg opacity-0 group-hover:opacity-100 transition translate-y-4 group-hover:translate-y-0"><Play fill="white" size={20}/></div></div>
                            {playlists.map(p => (
                                <div key={p.id} onClick={()=>{setSelPl(p);setView('pl_det')}} className="bg-[#181818] p-5 rounded-2xl aspect-square flex flex-col justify-end cursor-pointer hover:bg-[#282828] transition group relative"><div className="mb-auto bg-[#333] w-full aspect-square rounded-xl shadow-lg flex items-center justify-center"><Music size={48} className="text-gray-500"/></div><h3 className="font-bold mt-5 truncate">{p.name}</h3><p className="text-xs text-gray-400 font-medium mt-1">By {currentUser.email?.split('@')[0]}</p><div className="absolute right-4 bottom-28 bg-jamendo-500 rounded-full p-3.5 shadow-lg opacity-0 group-hover:opacity-100 transition translate-y-4 group-hover:translate-y-0"><Play fill="white" size={20}/></div></div>
                            ))}
                        </div>
                    </div>
                );
            }

            if (view === 'pl_det' && selPl) {
                return (
                    <div className="pt-10">
                        <div className="flex flex-col md:flex-row items-end gap-8 mb-10 px-6 md:px-8"><div className="w-52 h-52 bg-[#222] shadow-2xl flex items-center justify-center rounded-lg"><Music size={80} className="text-gray-600"/></div><div className="flex flex-col gap-3"><span className="uppercase text-xs font-black tracking-widest text-gray-400">Playlist</span><h1 className="text-5xl md:text-7xl font-black tracking-tight leading-none">{selPl.name}</h1><p className="text-sm font-medium text-gray-400 flex items-center gap-2"><User size={14}/> {currentUser?.email?.split('@')[0]} <span className="text-gray-600"></span> {selPl.tracks?.length||0} songs</p></div></div>
                        <div className="px-2 md:px-4">{selPl.tracks?.length ? <TrackList tracks={selPl.tracks} onPlay={onPlay} onArtistClick={onArtistClick}/> : <div className="text-center py-20 text-gray-500 font-bold"><p>This playlist is empty. Add songs from the player context menu!</p></div>}</div>
                    </div>
                );
            }

            if (view === 'home') return (
                <div className="pb-10">
                <div className="flex gap-3 mb-8 overflow-x-auto no-scrollbar py-4 sticky top-0 bg-[#121212]/95 backdrop-blur-xl z-20 px-6 md:px-8 border-b border-white/5">
                    {[{id:'focus',l:'Focus',i:Coffee},{id:'relax',l:'Relax',i:Moon},{id:'workout',l:'Workout',i:Dumbbell},{id:'party',l:'Party',i:PartyPopper}].map(m => (
                        <button key={m.id} onClick={() => onMood(m.id)} className={`flex items-center gap-2 px-5 py-2.5 rounded-full text-sm font-bold transition-all border border-transparent whitespace-nowrap ${selMood===m.id?'bg-white text-black scale-105 shadow-lg':'bg-[#222] text-white hover:bg-[#333] hover:border-white/10'}`}><m.i size={16}/> {m.l}</button>
                    ))}
                </div>
                <div className="px-6 md:px-8">
                    {selMood ? (
                        <div className="animate-slide-up"><div className="mb-6 flex items-center justify-between"><h2 className="text-4xl font-black capitalize text-white tracking-tight">{selMood} Mix</h2><button onClick={()=>setSelMood(null)} className="text-sm font-bold text-gray-400 hover:text-white underline">Clear Filter</button></div><TrackList tracks={moodList} onPlay={onPlay} onArtistClick={onArtistClick}/></div>
                    ) : (
                        <>
                            {heroLoad ? <div className="bg-[#181818] rounded-2xl p-6 md:p-12 mb-12 h-64 animate-pulse"/> : (
                                <div className="relative bg-gradient-to-br from-indigo-900 via-purple-900 to-jamendo-900 rounded-3xl p-8 md:p-12 mb-12 flex flex-col md:flex-row items-start md:items-end justify-between shadow-2xl overflow-hidden animate-slide-up group">
                                    <div className="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20 brightness-100 contrast-150 mix-blend-overlay"></div>
                                    <div className="absolute -top-20 -right-20 w-96 h-96 bg-jamendo-500 rounded-full blur-[100px] opacity-30 group-hover:opacity-40 transition duration-1000"></div>
                                    <div className="relative z-10"><div className="flex items-center gap-2 mb-3"><span className="bg-black/40 text-white text-[10px] font-black px-3 py-1 rounded-full backdrop-blur-md uppercase tracking-widest border border-white/10">{vibe} Edition</span></div><h1 className="text-4xl md:text-6xl font-black text-white mb-3 tracking-tight drop-shadow-lg">{greet}</h1><p className="text-white/80 max-w-md text-sm md:text-lg font-medium">Curated {vibe.toLowerCase()} vibes, freshly mixed for you.</p></div>
                                    {daily.length > 0 && <button onClick={()=>playPlaylist(daily)} className="mt-8 md:mt-0 relative z-10 bg-white text-black rounded-full p-4 md:px-8 md:py-4 font-black flex items-center gap-2 hover:scale-105 transition shadow-[0_0_30px_rgba(255,255,255,0.3)]"><Play fill="currentColor" size={24}/> <span className="hidden md:inline">Play Daily Mix</span></button>}
                                </div>
                            )}
                            {history.length > 0 && <Section title="Jump Back In" tracks={history.slice(0, 10)} onPlay={t=>onPlay(t,history.slice(0,10))} onArtistClick={onArtistClick}/>}
                            <Section title="Made For You" subtitle={`Based on your ${vibe} taste`} tracks={daily} onPlay={t=>onPlay(t,daily)} onArtistClick={onArtistClick}/>
                            <Section title={greet.includes('Morning')?'Start Your Day':greet.includes('Night')?'Sleepy Beats':'Vibe Check'} tracks={timeRec} onPlay={t=>onPlay(t,timeRec)} onArtistClick={onArtistClick}/>
                            <Section title="Trending Globally" tracks={trending} onPlay={t=>onPlay(t,trending)} onArtistClick={onArtistClick}/>
                            {explore.map((s,i) => <Section key={i} title={s.title} tracks={s.tracks} onPlay={t=>onPlay(t,s.tracks)} onArtistClick={onArtistClick}/>)}
                        </>
                    )}
                </div>
                </div>
            );

            if (view === 'search') return (
                <div className="pt-4 px-6 md:px-8">
                {query && !topRes && !trending.length && !loading && <div className="text-center mt-32 text-gray-500 font-bold"><p className="text-xl">No tracks found for "{query}".</p></div>}
                {topRes && (
                    <div className="mb-10 animate-slide-up">
                        <h2 className="text-2xl font-bold mb-5 text-white">Top Result</h2>
                        <div onClick={()=>onPlay(topRes,[topRes])} className="bg-[#181818] hover:bg-[#222] p-6 rounded-2xl flex items-center gap-8 cursor-pointer transition duration-300 group relative overflow-hidden w-full md:w-2/3 border border-white/5 hover:border-white/10">
                            <div className="relative h-32 w-32 md:h-40 md:w-40 flex-shrink-0 shadow-2xl rounded-lg overflow-hidden">
                                <img src={topRes.album_image} className="h-full w-full object-cover group-hover:scale-110 transition duration-700"/>
                                <div className="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition duration-300 backdrop-blur-[2px]">
                                    <div className="bg-jamendo-500 rounded-full p-4 text-white shadow-xl scale-90 group-hover:scale-100 transition"><Play fill="currentColor" size={28}/></div>
                                </div>
                            </div>
                            <div className="flex flex-col gap-2 min-w-0">
                                <h3 className="text-3xl md:text-5xl font-black text-white truncate tracking-tight">{topRes.name}</h3>
                                <p className="text-gray-400 font-bold text-lg truncate flex items-center gap-2"><span className="text-white">{topRes.artist_name}</span> <span className="w-1 h-1 bg-gray-500 rounded-full"/> <span className="text-sm font-medium">Song</span></p>
                                <div className="mt-2 flex gap-2">
                                    <span className="inline-flex items-center gap-1.5 text-[10px] font-black uppercase tracking-wider bg-white text-black px-3 py-1 rounded-full"><CheckCircle size={12} fill="black" className="text-white"/> Best Match</span>
                                </div>
                            </div>
                        </div>
                    </div>
                )}
                {trending.length > 0 && <TrackList tracks={trending} onPlay={onPlay} onArtistClick={onArtistClick} title={topRes ? "More Results" : `Results for "${query}"`}/>}
                </div>
            );

            if (view === 'liked') return <div className="pt-10"><div className="flex flex-col md:flex-row items-end gap-8 mb-10 px-6 md:px-8"><div className="w-52 h-52 bg-gradient-to-br from-indigo-700 to-blue-300 shadow-2xl flex items-center justify-center rounded-lg"><Heart size={80} fill="white" className="text-white"/></div><div className="flex flex-col gap-3"><span className="uppercase text-xs font-black tracking-widest text-white">Playlist</span><h1 className="text-5xl md:text-7xl font-black tracking-tight leading-none">Liked Songs</h1><p className="text-sm font-medium text-white/80">{favorites.length} songs</p></div></div><div className="px-2 md:px-4"><TrackList tracks={favorites} onPlay={onPlay} onArtistClick={onArtistClick}/></div></div>;
            if (view === 'artist') return <div className="pt-10"><div className="flex items-center gap-8 mb-12 px-6 md:px-8"><div className="w-40 h-40 md:w-56 md:h-56 bg-[#222] rounded-full shadow-2xl flex items-center justify-center border-4 border-white/5"><User size={80} className="text-gray-500"/></div><div className="flex flex-col gap-2"><span className="uppercase text-xs font-black tracking-widest flex items-center gap-1 text-jamendo-500"><CheckCircle size={14} fill="currentColor" className="text-black"/> Verified Artist</span><h1 className="text-5xl md:text-8xl font-black tracking-tighter">{artist?.name}</h1><p className="text-gray-400 font-medium">Monthly Listeners: {Math.floor(Math.random() * 1000000).toLocaleString()}</p></div></div><div className="px-2 md:px-4"><TrackList tracks={trending} onPlay={onPlay} onArtistClick={onArtistClick} title="Popular Tracks"/></div></div>;
            return null;
          };

          return (
            <div className="flex h-screen bg-black text-white font-sans selection:bg-jamendo-500 selection:text-white">
              <Sidebar currentView={view} onChangeView={v=>{setView(v);setQuery('')}} onCreatePlaylist={createPl}/>
              <main className="flex-1 bg-[#121212] flex flex-col relative overflow-hidden">
                <div className={`h-20 flex items-center px-6 md:px-8 justify-between sticky top-0 z-30 transition-all duration-300 ${view==='home'?'bg-transparent':'bg-[#121212]/95 backdrop-blur-xl border-b border-white/5'}`}>
                    <div className="flex items-center gap-4 w-full max-w-xl">
                        <div className="flex gap-2 mr-2 md:hidden"><Globe className="text-jamendo-500"/></div>
                        {view==='search' ? <SearchBar onSearch={onSearch} initialQuery={query}/> : (view==='home'?null:<div className="text-xl font-black tracking-tight hidden md:block">VEX MUSIC</div>)}
                    </div>
                    <div className="flex items-center gap-4 hidden md:flex">
                        <button className="text-xs font-bold bg-white text-black px-5 py-2.5 rounded-full hover:scale-105 transition shadow-lg" onClick={()=>setView('explore')}>Upgrade to Premium</button>
                        <div className="w-9 h-9 bg-jamendo-600 rounded-full flex items-center justify-center font-bold text-sm cursor-pointer">{currentUser?.email?.[0].toUpperCase() || 'G'}</div>
                    </div>
                </div>
                <div className="flex-1 overflow-y-auto pb-32 scroll-smooth custom-scrollbar">{render()}</div>
                <Player/>
                <MobileNav currentView={view} onChangeView={v=>{setView(v);setQuery('')}}/>
              </main>
            </div>
          );
        };

        const App = () => {
          return (
            <AuthProvider>
              <PlayerProvider>
                <ContentArea />
              </PlayerProvider>
            </AuthProvider>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
  <script type="module" src="/index.tsx"></script>
</body>
</html>
