<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>VEX MUSIC</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              jamendo: {
                500: "#8c366c",
                600: "#752d5b",
              },
            },
            animation: {
              "slide-up": "slideUp 0.3s ease-out forwards",
            },
            keyframes: {
              slideUp: {
                "0%": { transform: "translateY(100%)", opacity: "0" },
                "100%": { transform: "translateY(0)", opacity: "1" },
              },
            },
          },
        },
      };
    </script>
    <style>
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: #000; }
      ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
      .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
      {
        "imports": {
          "lucide-react": "https://esm.sh/lucide-react@0.294.0",
          "react": "https://esm.sh/react@18.2.0",
          "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
          "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
          "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
          "firebase/database": "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js",
          "firebase/storage": "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js"
        }
      }
    </script>
  </head>
  <body class="bg-black text-white overflow-hidden touch-none h-screen w-screen">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel" data-type="module">
      import React, { createContext, useContext, useState, useEffect, useCallback, useRef } from "react";
      import ReactDOM from "react-dom/client";
      import { Home, Search, Library, PlusSquare, Heart, Globe, LogIn, LogOut, Play, Pause, SkipBack, SkipForward, Repeat, Shuffle, Volume2, VolumeX, Maximize2, ChevronDown, MoreHorizontal, ListMusic, X, GripVertical, Moon, Clock, PartyPopper, CheckCircle, Music, Plus, User, Radio, Trash2, Users, Upload, Settings, ShieldCheck, Check, Edit2 } from "lucide-react";
      import { initializeApp } from "firebase/app";
      import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "firebase/auth";
      import { getDatabase, ref, push, set, onValue, get, update, remove, query, orderByChild, equalTo } from "firebase/database";
      import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "firebase/storage";

      // --- CONFIG ---
      const ADMIN_EMAIL = "itznathax967@gmail.com";
      
      const firebaseConfig = {
        apiKey: "AIzaSyA6jb5U-x8CSFtHCZMVqHaWzLeV98MoWGE",
        authDomain: "studio-3733366627-e5d3d.firebaseapp.com",
        databaseURL: "https://studio-3733366627-e5d3d-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "studio-3733366627-e5d3d",
        storageBucket: "studio-3733366627-e5d3d.firebasestorage.app",
        messagingSenderId: "195800850019",
        appId: "1:195800850019:web:1730ace5541b7a10126256",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getDatabase(app);
      const storage = getStorage(app);

      // --- UTILS ---
      const formatTime = (s) => `${Math.floor(s / 60)}:${Math.floor(s % 60).toString().padStart(2, "0")}`;

      // --- CONTEXTS ---
      const AuthContext = createContext(undefined);
      const useAuth = () => useContext(AuthContext);

      const AuthProvider = ({ children }) => {
        const [currentUser, setCurrentUser] = useState(null);
        const [userData, setUserData] = useState(null);
        const [loading, setLoading] = useState(true);

        useEffect(() => onAuthStateChanged(auth, (u) => {
            setCurrentUser(u);
            if (u) {
                // Fetch extra user data (verified status, etc)
                onValue(ref(db, `users/${u.uid}`), (snap) => {
                    setUserData(snap.val());
                    setLoading(false);
                });
            } else {
                setUserData(null);
                setLoading(false);
            }
        }), []);

        const logout = () => signOut(auth);
        
        const updateUserProfile = async (name, photoURL) => {
            if(!currentUser) return;
            await updateProfile(currentUser, { displayName: name, photoURL: photoURL });
            await update(ref(db, `users/${currentUser.uid}`), { displayName: name, photoURL: photoURL });
            // Force refresh local state
            setCurrentUser({...currentUser, displayName: name, photoURL: photoURL});
        };

        return (
          <AuthContext.Provider value={{ currentUser, userData, loading, logout, updateUserProfile, isAdmin: currentUser?.email === ADMIN_EMAIL }}>
            {!loading && children}
          </AuthContext.Provider>
        );
      };

      const PlayerContext = createContext(undefined);
      const usePlayer = () => useContext(PlayerContext);

      const PlayerProvider = ({ children }) => {
        const [state, setState] = useState({ currentTrack: null, isPlaying: false, volume: 1, currentTime: 0, duration: 0, queue: [], isShuffling: false, repeatMode: "off" });
        const audioRef = useRef(new Audio());

        useEffect(() => {
            const audio = audioRef.current;
            const update = () => setState(p => ({ ...p, currentTime: audio.currentTime }));
            const dur = () => setState(p => ({ ...p, duration: audio.duration }));
            const end = () => nextTrack();
            audio.addEventListener("timeupdate", update);
            audio.addEventListener("loadedmetadata", dur);
            audio.addEventListener("ended", end);
            return () => { audio.pause(); audio.src=""; };
        }, []);

        useEffect(() => {
            if(state.currentTrack) {
                if(audioRef.current.src !== state.currentTrack.audio) {
                    audioRef.current.src = state.currentTrack.audio;
                    audioRef.current.load();
                }
                if(state.isPlaying) audioRef.current.play().catch(e=>console.log(e));
                else audioRef.current.pause();
            }
        }, [state.currentTrack, state.isPlaying]);

        const playTrack = (t) => setState(p => ({ ...p, currentTrack: t, isPlaying: true, queue: [t] }));
        const playPlaylist = (q, i=0) => setState(p => ({ ...p, queue: q, currentTrack: q[i], isPlaying: true }));
        const togglePlay = () => setState(p => ({ ...p, isPlaying: !p.isPlaying }));
        const nextTrack = () => {
            setState(p => {
                if(!p.queue.length) return p;
                const idx = p.queue.findIndex(t => t.id === p.currentTrack?.id);
                const next = (idx + 1) % p.queue.length;
                return { ...p, currentTrack: p.queue[next], isPlaying: true };
            });
        };
        const prevTrack = () => {
             setState(p => {
                if(!p.queue.length) return p;
                const idx = p.queue.findIndex(t => t.id === p.currentTrack?.id);
                const prev = (idx - 1 + p.queue.length) % p.queue.length;
                return { ...p, currentTrack: p.queue[prev], isPlaying: true };
            });
        };

        return (
          <PlayerContext.Provider value={{ ...state, playTrack, playPlaylist, togglePlay, nextTrack, prevTrack, seek: (t) => audioRef.current.currentTime = t }}>
            {children}
          </PlayerContext.Provider>
        );
      };

      // --- COMPONENTS ---
      const TrackList = ({ tracks, onPlay }) => (
          <div className="space-y-1">
              {tracks.map((t, i) => (
                  <div key={t.id} onClick={() => onPlay(t, tracks)} className="flex items-center gap-4 p-2 rounded-lg hover:bg-white/10 cursor-pointer group">
                      <img src={t.album_image || "https://placehold.co/100"} className="w-10 h-10 rounded object-cover" />
                      <div className="flex-1 min-w-0">
                          <div className="font-bold text-sm truncate flex items-center gap-2">
                              {t.name}
                              {t.verified && <CheckCircle size={12} className="text-blue-400" fill="currentColor" color="black"/>}
                          </div>
                          <div className="text-xs text-gray-400 truncate">{t.artist_name}</div>
                      </div>
                      <button className="opacity-0 group-hover:opacity-100"><Play size={16} /></button>
                  </div>
              ))}
          </div>
      );

      const UploadModal = ({ onClose }) => {
          const { currentUser, userData } = useAuth();
          const [file, setFile] = useState(null);
          const [thumb, setThumb] = useState(null);
          const [name, setName] = useState("");
          const [uploading, setUploading] = useState(false);

          const handleUpload = async (e) => {
              e.preventDefault();
              if(!file || !name || !thumb) return alert("All fields required");
              setUploading(true);

              try {
                  // 1. Upload Audio
                  const audioRef = sRef(storage, `songs/${currentUser.uid}/${Date.now()}_${file.name}`);
                  await uploadBytes(audioRef, file);
                  const audioUrl = await getDownloadURL(audioRef);

                  // 2. Upload Thumb
                  const thumbRef = sRef(storage, `thumbs/${currentUser.uid}/${Date.now()}_${thumb.name}`);
                  await uploadBytes(thumbRef, thumb);
                  const thumbUrl = await getDownloadURL(thumbRef);

                  // 3. Save to DB
                  const isVerified = userData?.isVerified;
                  const songData = {
                      name: name,
                      artist_name: currentUser.displayName || "Unknown Artist",
                      artist_id: currentUser.uid,
                      audio: audioUrl,
                      album_image: thumbUrl,
                      uploadedAt: Date.now(),
                      status: isVerified ? "approved" : "pending", // Verified users skip approval
                      verified: isVerified || false
                  };
                  
                  await push(ref(db, "uploads"), songData);
                  alert(isVerified ? "Published successfully!" : "Uploaded! Waiting for Admin Approval.");
                  onClose();
              } catch (err) {
                  alert("Error uploading: " + err.message);
              } finally {
                  setUploading(false);
              }
          };

          return (
              <div className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
                  <div className="bg-[#181818] p-6 rounded-2xl w-full max-w-md border border-white/10">
                      <h2 className="text-2xl font-bold mb-4">Upload Music</h2>
                      <form onSubmit={handleUpload} className="space-y-4">
                          <input type="text" placeholder="Song Name" className="w-full p-3 bg-[#222] rounded text-white border border-white/10" value={name} onChange={e=>setName(e.target.value)} required />
                          <div>
                              <label className="block text-xs text-gray-400 mb-1">Song File (MP3)</label>
                              <input type="file" accept="audio/*" onChange={e=>setFile(e.target.files[0])} className="w-full text-sm text-gray-400" required />
                          </div>
                          <div>
                              <label className="block text-xs text-gray-400 mb-1">Cover Art</label>
                              <input type="file" accept="image/*" onChange={e=>setThumb(e.target.files[0])} className="w-full text-sm text-gray-400" required />
                          </div>
                          <div className="flex gap-2 pt-2">
                              <button type="button" onClick={onClose} className="flex-1 py-3 bg-gray-700 rounded font-bold">Cancel</button>
                              <button type="submit" disabled={uploading} className="flex-1 py-3 bg-jamendo-500 rounded font-bold disabled:opacity-50">
                                  {uploading ? "Uploading..." : "Upload"}
                              </button>
                          </div>
                      </form>
                  </div>
              </div>
          );
      };

      const AdminPanel = () => {
          const [pending, setPending] = useState([]);
          const [users, setUsers] = useState([]);

          useEffect(() => {
              // Fetch Pending Songs
              const q = query(ref(db, "uploads"), orderByChild("status"), equalTo("pending"));
              onValue(q, (snap) => {
                  const d = snap.val();
                  setPending(d ? Object.keys(d).map(k => ({id: k, ...d[k]})) : []);
              });

              // Fetch All Users (for verification)
              onValue(ref(db, "users"), (snap) => {
                  const d = snap.val();
                  setUsers(d ? Object.keys(d).map(k => ({uid: k, ...d[k]})) : []);
              });
          }, []);

          const approveSong = async (id) => await update(ref(db, `uploads/${id}`), { status: "approved" });
          const rejectSong = async (id) => await remove(ref(db, `uploads/${id}`));
          
          const toggleVerify = async (uid, currentStatus) => {
              await update(ref(db, `users/${uid}`), { isVerified: !currentStatus });
          };

          return (
              <div className="p-6 pt-20">
                  <h1 className="text-3xl font-black mb-8 flex items-center gap-2"><ShieldCheck className="text-green-500"/> Admin Dashboard</h1>
                  
                  <div className="mb-12">
                      <h2 className="text-xl font-bold mb-4 text-gray-300 border-b border-gray-700 pb-2">Pending Approvals</h2>
                      {pending.length === 0 ? <p className="text-gray-500">No pending songs.</p> : (
                          <div className="grid gap-4">
                              {pending.map(s => (
                                  <div key={s.id} className="bg-[#181818] p-4 rounded flex items-center justify-between border border-white/10">
                                      <div className="flex items-center gap-4">
                                          <img src={s.album_image} className="w-12 h-12 rounded bg-black" />
                                          <div>
                                              <div className="font-bold">{s.name}</div>
                                              <div className="text-xs text-gray-400">by {s.artist_name}</div>
                                              <audio src={s.audio} controls className="h-6 mt-1 w-48"/>
                                          </div>
                                      </div>
                                      <div className="flex gap-2">
                                          <button onClick={() => approveSong(s.id)} className="p-2 bg-green-500/20 text-green-500 rounded hover:bg-green-500/30"><Check size={18}/></button>
                                          <button onClick={() => rejectSong(s.id)} className="p-2 bg-red-500/20 text-red-500 rounded hover:bg-red-500/30"><X size={18}/></button>
                                      </div>
                                  </div>
                              ))}
                          </div>
                      )}
                  </div>

                  <div>
                      <h2 className="text-xl font-bold mb-4 text-gray-300 border-b border-gray-700 pb-2">User Verification</h2>
                      <div className="grid gap-2">
                          {users.map(u => (
                              <div key={u.uid} className="flex items-center justify-between p-3 bg-[#181818] rounded">
                                  <div className="flex items-center gap-3">
                                      <img src={u.photoURL || "https://placehold.co/50"} className="w-8 h-8 rounded-full" />
                                      <div>
                                          <div className="font-bold text-sm flex items-center gap-1">
                                              {u.displayName || "User"}
                                              {u.isVerified && <CheckCircle size={12} className="text-blue-400" fill="currentColor" color="black"/>}
                                          </div>
                                          <div className="text-xs text-gray-500">{u.email}</div>
                                      </div>
                                  </div>
                                  <button 
                                    onClick={() => toggleVerify(u.uid, u.isVerified)}
                                    className={`text-xs px-3 py-1 rounded font-bold ${u.isVerified ? 'bg-red-500/10 text-red-400' : 'bg-blue-500/10 text-blue-400'}`}
                                  >
                                      {u.isVerified ? "Revoke" : "Verify"}
                                  </button>
                              </div>
                          ))}
                      </div>
                  </div>
              </div>
          );
      };

      const ProfileEditor = ({ onClose }) => {
          const { currentUser, updateUserProfile } = useAuth();
          const [name, setName] = useState(currentUser?.displayName || "");
          const [pic, setPic] = useState(currentUser?.photoURL || "");

          const handleSave = async (e) => {
              e.preventDefault();
              await updateUserProfile(name, pic);
              onClose();
          };

          return (
              <div className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
                  <div className="bg-[#181818] p-6 rounded-2xl w-full max-w-sm border border-white/10">
                      <h2 className="text-xl font-bold mb-4">Edit Profile</h2>
                      <form onSubmit={handleSave} className="space-y-4">
                          <div className="flex justify-center mb-4">
                              <img src={pic || "https://placehold.co/100"} className="w-20 h-20 rounded-full object-cover border-2 border-jamendo-500" />
                          </div>
                          <div>
                              <label className="text-xs text-gray-400">Display Name</label>
                              <input value={name} onChange={e=>setName(e.target.value)} className="w-full bg-[#222] p-2 rounded text-white border border-white/10" />
                          </div>
                          <div>
                              <label className="text-xs text-gray-400">Profile Picture URL</label>
                              <input value={pic} onChange={e=>setPic(e.target.value)} placeholder="https://..." className="w-full bg-[#222] p-2 rounded text-white border border-white/10" />
                          </div>
                          <div className="flex gap-2">
                              <button type="button" onClick={onClose} className="flex-1 py-2 bg-gray-700 rounded">Cancel</button>
                              <button type="submit" className="flex-1 py-2 bg-jamendo-500 rounded font-bold">Save</button>
                          </div>
                      </form>
                  </div>
              </div>
          );
      };

      // --- MAIN LAYOUT ---
      const App = () => {
          const { currentUser, logout, isAdmin, userData } = useAuth();
          const { currentTrack, isPlaying, playTrack, togglePlay, nextTrack, prevTrack, queue } = usePlayer();
          const [view, setView] = useState("home");
          const [showUpload, setShowUpload] = useState(false);
          const [showProfile, setShowProfile] = useState(false);
          const [uploads, setUploads] = useState([]);
          const [searchQ, setSearchQ] = useState("");

          useEffect(() => {
              // Fetch Approved Uploads
              const q = query(ref(db, "uploads"), orderByChild("status"), equalTo("approved"));
              onValue(q, (snap) => {
                  const d = snap.val();
                  const list = d ? Object.keys(d).map(k => ({id: k, source: "upload", ...d[k]})) : [];
                  setUploads(list.reverse()); // Newest first
              });
          }, []);

          const filteredUploads = searchQ ? uploads.filter(s => s.name.toLowerCase().includes(searchQ.toLowerCase())) : uploads;

          const renderContent = () => {
              if (view === "admin") return <AdminPanel />;
              
              return (
                  <div className="p-6 pt-20 pb-32">
                      <div className="flex items-center gap-4 mb-8">
                          <div className="relative flex-1">
                             <Search className="absolute left-3 top-3 text-gray-500" size={20} />
                             <input 
                                value={searchQ}
                                onChange={e => setSearchQ(e.target.value)}
                                placeholder="Search new releases..." 
                                className="w-full bg-[#181818] p-3 pl-10 rounded-full text-white focus:outline-none focus:ring-1 focus:ring-white/20"
                             />
                          </div>
                      </div>

                      <div className="mb-8">
                          <h2 className="text-2xl font-bold mb-4">New Releases</h2>
                          {filteredUploads.length === 0 ? (
                              <div className="text-gray-500">No songs found. Be the first to upload!</div>
                          ) : (
                              <TrackList tracks={filteredUploads} onPlay={playTrack} />
                          )}
                      </div>
                  </div>
              );
          };

          return (
              <div className="flex h-full bg-black">
                   {/* Sidebar */}
                   <div className="w-64 bg-black border-r border-[#222] hidden md:flex flex-col p-4">
                       <h1 className="text-2xl font-black flex gap-2 items-center mb-8"><Globe className="text-jamendo-500"/> VEX</h1>
                       <nav className="space-y-2 flex-1">
                           <button onClick={()=>setView("home")} className={`flex gap-3 items-center w-full p-3 rounded font-bold ${view==="home"?"bg-[#222] text-white":"text-gray-400 hover:text-white"}`}><Home size={20}/> Home</button>
                           {isAdmin && (
                               <button onClick={()=>setView("admin")} className={`flex gap-3 items-center w-full p-3 rounded font-bold ${view==="admin"?"bg-[#222] text-white":"text-gray-400 hover:text-white"}`}><ShieldCheck size={20}/> Admin</button>
                           )}
                       </nav>
                       {currentUser ? (
                           <div className="border-t border-[#222] pt-4">
                               <div className="flex items-center gap-3 mb-4">
                                   <img src={currentUser.photoURL || "https://placehold.co/50"} className="w-10 h-10 rounded-full object-cover" />
                                   <div className="flex-1 overflow-hidden">
                                       <div className="font-bold truncate text-sm flex items-center gap-1">
                                            {currentUser.displayName || "User"}
                                            {userData?.isVerified && <CheckCircle size={12} className="text-blue-400" fill="currentColor" color="black"/>}
                                       </div>
                                       <button onClick={()=>setShowProfile(true)} className="text-[10px] text-gray-400 hover:text-white flex items-center gap-1"><Edit2 size={8}/> Edit Profile</button>
                                   </div>
                               </div>
                               <button onClick={()=>setShowUpload(true)} className="w-full bg-white text-black font-bold py-2 rounded mb-2 flex items-center justify-center gap-2"><Upload size={16}/> Upload</button>
                               <button onClick={logout} className="w-full text-red-500 font-bold text-sm flex items-center gap-2"><LogOut size={16}/> Logout</button>
                           </div>
                       ) : (
                           <button onClick={()=>alert("Use standard login")} className="bg-jamendo-500 w-full py-3 rounded font-bold">Login</button>
                       )}
                   </div>

                   {/* Main Content */}
                   <div className="flex-1 overflow-y-auto bg-[#121212] relative">
                       {renderContent()}
                   </div>

                   {/* Player Bar */}
                   {currentTrack && (
                       <div className="fixed bottom-0 left-0 w-full h-20 bg-[#181818] border-t border-white/10 flex items-center px-4 z-50">
                           <div className="flex items-center gap-4 w-1/3">
                               <img src={currentTrack.album_image} className="w-14 h-14 rounded bg-black" />
                               <div>
                                   <div className="font-bold text-sm text-white">{currentTrack.name}</div>
                                   <div className="text-xs text-gray-400">{currentTrack.artist_name}</div>
                               </div>
                           </div>
                           <div className="flex-1 flex flex-col items-center">
                               <div className="flex gap-4 mb-1">
                                   <button onClick={prevTrack}><SkipBack fill="white" size={20}/></button>
                                   <button onClick={togglePlay} className="bg-white rounded-full p-1 text-black">
                                       {isPlaying ? <Pause fill="black" size={20}/> : <Play fill="black" size={20} className="ml-0.5"/>}
                                   </button>
                                   <button onClick={nextTrack}><SkipForward fill="white" size={20}/></button>
                               </div>
                           </div>
                           <div className="w-1/3"></div>
                       </div>
                   )}

                   {/* Modals */}
                   {showUpload && <UploadModal onClose={()=>setShowUpload(false)} />}
                   {showProfile && <ProfileEditor onClose={()=>setShowProfile(false)} />}
              </div>
          );
      };

      // --- BOOTSTRAP ---
      const Root = () => (
          <AuthProvider>
              <PlayerProvider>
                  <App />
              </PlayerProvider>
          </AuthProvider>
      );

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<Root />);
    </script>
  </body>
</html>
